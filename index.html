<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŒ¿ Pflanzenfinder â€“ Mein KrÃ¤uterbuch</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Pflanzenfinder">
<meta name="theme-color" content="#2d5016">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
  --bg: #f4efe4;
  --bg2: #ece5d2;
  --green-dark: #2d5016;
  --green-mid: #4a7c2f;
  --green-light: #7aab52;
  --green-pale: #d4e8c2;
  --earth: #8b6914;
  --earth-light: #c4a35a;
  --cream: #faf7ee;
  --text: #1e2d0e;
  --text-muted: #5a6e3a;
  --accent: #c45c1a;
  --red: #c0392b;
  --shadow: rgba(45,80,22,0.15);
  --radius: 14px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Lato',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;
  background-image:radial-gradient(ellipse at 5% 15%,rgba(122,171,82,.07) 0%,transparent 55%),
  radial-gradient(ellipse at 95% 85%,rgba(196,163,90,.09) 0%,transparent 55%);}

/* â”€â”€ HEADER â”€â”€ */
header{background:linear-gradient(135deg,var(--green-dark) 0%,var(--green-mid) 65%,var(--green-light) 100%);
  padding:16px 24px;display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 4px 20px var(--shadow);position:sticky;top:0;z-index:200;}
header h1{font-family:'Playfair Display',serif;color:#fff;font-size:1.65rem;display:flex;align-items:center;gap:10px;}
header h1 small{font-style:italic;font-weight:400;opacity:.8;font-size:1rem;}
.header-actions{display:flex;gap:8px;}

/* â”€â”€ NAV â”€â”€ */
nav{display:flex;gap:4px;background:var(--bg2);padding:10px 18px;border-bottom:2px solid var(--green-pale);overflow-x:auto;flex-wrap:wrap;}
nav button{padding:7px 16px;border:2px solid transparent;border-radius:22px;background:transparent;
  color:var(--text-muted);font-family:'Lato',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;
  white-space:nowrap;transition:all .2s;letter-spacing:.4px;}
nav button.active,nav button:hover{background:var(--green-mid);color:#fff;border-color:var(--green-dark);}

/* â”€â”€ MAIN â”€â”€ */
main{padding:18px;max-width:1300px;margin:0 auto;}
.section{display:none;animation:fadeIn .3s ease;}
.section.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{padding:9px 20px;border-radius:26px;border:none;font-family:'Lato',sans-serif;font-weight:700;
  font-size:.9rem;cursor:pointer;transition:all .2s;letter-spacing:.4px;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:var(--green-mid);color:#fff;}
.btn-primary:hover{background:var(--green-dark);transform:translateY(-1px);}
.btn-secondary{background:transparent;color:var(--green-mid);border:2px solid var(--green-mid);}
.btn-secondary:hover{background:var(--green-pale);}
.btn-danger{background:var(--red);color:#fff;}
.btn-sm{padding:5px 13px;font-size:.8rem;}
.btn-icon{padding:6px 10px;border-radius:8px;font-size:.85rem;}
.btn-earth{background:var(--earth-light);color:#fff;}
.btn-earth:hover{background:var(--earth);}

/* â”€â”€ CARDS GRID â”€â”€ */
.plants-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:18px;margin-top:16px;}
.plant-card{background:var(--cream);border-radius:var(--radius);overflow:hidden;
  box-shadow:0 4px 14px var(--shadow);border:1px solid rgba(122,171,82,.2);
  transition:transform .2s,box-shadow .2s;cursor:pointer;}
.plant-card:hover{transform:translateY(-4px);box-shadow:0 8px 24px var(--shadow);}
.plant-card-img{width:100%;height:150px;display:flex;align-items:center;justify-content:center;
  font-size:3.5rem;background:linear-gradient(135deg,var(--green-pale),var(--bg2));position:relative;overflow:hidden;}
.plant-card-img img{width:100%;height:100%;object-fit:cover;}
.cat-ribbon{position:absolute;top:10px;right:10px;padding:3px 10px;border-radius:12px;
  font-size:.72rem;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.3);}
.plant-card-body{padding:14px;}
.plant-card-body h3{font-family:'Playfair Display',serif;font-size:1.15rem;color:var(--green-dark);margin-bottom:3px;}
.plant-card-body .latin{font-style:italic;color:var(--text-muted);font-size:.8rem;margin-bottom:8px;}
.tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;}
.tag{font-size:.7rem;padding:2px 9px;border-radius:16px;font-weight:700;}
.tag-season{background:#fff3cd;color:#856404;}
.tag-use{background:var(--green-pale);color:var(--green-dark);}
.tag-loc{background:#fde8d8;color:var(--accent);}
.tag-cat{color:#fff;font-size:.7rem;padding:2px 9px;border-radius:16px;font-weight:700;}
.loc-count{font-size:.78rem;color:var(--text-muted);display:flex;align-items:center;gap:4px;}

/* â”€â”€ FORM â”€â”€ */
.form-card{background:var(--cream);border-radius:20px;padding:28px;box-shadow:0 4px 20px var(--shadow);
  border:1px solid rgba(122,171,82,.2);max-width:760px;}
.form-card h2{font-family:'Playfair Display',serif;color:var(--green-dark);margin-bottom:22px;font-size:1.45rem;}
.form-group{margin-bottom:16px;}
.form-group label{display:block;font-weight:700;color:var(--text-muted);font-size:.82rem;
  margin-bottom:5px;text-transform:uppercase;letter-spacing:.7px;}
.form-group input,.form-group textarea,.form-group select{width:100%;padding:9px 13px;
  border:2px solid var(--green-pale);border-radius:9px;font-family:'Lato',sans-serif;
  font-size:.93rem;background:#fff;color:var(--text);transition:border-color .2s;outline:none;}
.form-group input:focus,.form-group textarea:focus,.form-group select:focus{border-color:var(--green-mid);}
.form-group textarea{min-height:75px;resize:vertical;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
@media(max-width:500px){.form-row{grid-template-columns:1fr;}}
.btn-group{display:flex;gap:10px;flex-wrap:wrap;margin-top:18px;}

/* â”€â”€ CATEGORY SELECT â”€â”€ */
.cat-select-wrap{display:flex;gap:8px;align-items:center;}
.cat-select-wrap select{flex:1;}
.cat-add-input{display:flex;gap:6px;margin-top:6px;}
.cat-add-input input{flex:1;padding:7px 12px;border:2px solid var(--green-pale);border-radius:8px;
  font-family:'Lato',sans-serif;font-size:.9rem;outline:none;}
.cat-add-input input:focus{border-color:var(--green-mid);}

/* â”€â”€ STAGE CHECKBOXES â”€â”€ */
.stage-badges-wrap{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
.stage-label{display:flex;align-items:center;gap:5px;cursor:pointer;font-size:.88rem;font-weight:normal;text-transform:none;letter-spacing:0;}
.stage-badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:.75rem;font-weight:700;}
.stage-jungpflanze{background:#d4f5d4;color:#1a6b1a;}
.stage-halbwuchs{background:#fff3cd;color:#856404;}
.stage-altpflanze{background:#fde8d8;color:#8b3800;}
.stage-saatgut{background:#e8d4f5;color:#5a1a6b;}

/* â”€â”€ GPS BUTTON â”€â”€ */
.gps-btn{display:inline-flex;align-items:center;gap:6px;padding:7px 13px;
  background:var(--earth-light);color:#fff;border:none;border-radius:8px;cursor:pointer;
  font-size:.83rem;font-weight:700;margin-top:5px;}
.gps-btn:hover{background:var(--earth);}

/* â”€â”€ LOCATIONS LIST in form â”€â”€ */
.locations-editor{background:#f0f7e8;border-radius:10px;padding:14px;margin-top:8px;}
.location-item{display:flex;align-items:center;gap:8px;padding:8px;background:#fff;
  border-radius:8px;margin-bottom:8px;border:1px solid var(--green-pale);}
.location-item .loc-coords{flex:1;font-size:.82rem;color:var(--text-muted);}
.location-item .loc-name{font-weight:700;font-size:.9rem;}
.add-loc-form{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:end;margin-top:8px;}
@media(max-width:500px){.add-loc-form{grid-template-columns:1fr;}}
.add-loc-form input{padding:8px 12px;border:2px solid var(--green-pale);border-radius:8px;
  font-family:'Lato',sans-serif;font-size:.88rem;outline:none;}
.add-loc-form input:focus{border-color:var(--green-mid);}

/* â”€â”€ CALENDAR â”€â”€ */
.cal-wrap{overflow-x:auto;border-radius:var(--radius);box-shadow:0 4px 16px var(--shadow);}
.cal-table{width:100%;border-collapse:collapse;min-width:800px;background:var(--cream);}
.cal-table thead tr th{background:var(--green-dark);color:#fff;padding:10px 8px;font-size:.78rem;
  font-weight:700;letter-spacing:.5px;text-align:left;}
.cal-table thead tr th:first-child{min-width:160px;}
.cal-table thead tr th.month-th{min-width:52px;text-align:center;}
.cal-table tbody tr{cursor:pointer;transition:background .15s;}
.cal-table tbody tr:hover td{background:rgba(212,232,194,.35)!important;}
.cal-table tbody tr:nth-child(even) td{background:rgba(244,239,228,.7);}
.cal-table tbody tr td{padding:9px 8px;border-bottom:1px solid rgba(122,171,82,.15);vertical-align:middle;}
.plant-name-cell{font-weight:700;font-size:.9rem;color:var(--green-dark);display:flex;align-items:center;gap:6px;}
.plant-latin-cell{font-size:.75rem;font-style:italic;color:var(--text-muted);}
.stage-cell{text-align:center;}
.month-cell{padding:6px 4px!important;text-align:center;}
.month-bar-wrap{height:20px;border-radius:10px;overflow:hidden;background:#e8e0d0;min-width:40px;margin:0 2px;}
.month-bar-fill{height:100%;border-radius:10px;transition:width .4s;}

/* â”€â”€ MAP â”€â”€ */
#mapContainer{height:480px;border-radius:var(--radius);overflow:hidden;
  box-shadow:0 4px 20px var(--shadow);border:2px solid var(--green-pale);}
.map-controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;align-items:center;}
.cat-filter-btn{padding:6px 14px;border-radius:20px;border:2px solid;font-size:.82rem;font-weight:700;
  cursor:pointer;transition:all .2s;font-family:'Lato',sans-serif;}
.cat-filter-btn.active{color:#fff;border-color:transparent;}
.cat-filter-btn:not(.active){background:transparent;}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(30,45,14,.6);z-index:1000;
  backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:20px;}
.modal-overlay.open{display:flex;animation:fadeIn .2s ease;}
.modal{background:var(--cream);border-radius:20px;max-width:680px;width:100%;
  max-height:92vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);}
.modal-header{background:linear-gradient(135deg,var(--green-dark),var(--green-mid));padding:22px 28px;
  color:#fff;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:flex-start;}
.modal-header h2{font-family:'Playfair Display',serif;font-size:1.5rem;}
.modal-header .latin{font-style:italic;opacity:.8;font-size:.88rem;margin-top:3px;}
.modal-close{background:none;border:none;color:#fff;font-size:1.4rem;cursor:pointer;opacity:.8;line-height:1;}
.modal-close:hover{opacity:1;}
.modal-body{padding:22px 28px;}
.modal-section{margin-bottom:20px;}
.modal-section h4{font-family:'Playfair Display',serif;color:var(--green-dark);font-size:.98rem;
  margin-bottom:8px;padding-bottom:4px;border-bottom:2px solid var(--green-pale);display:flex;align-items:center;gap:7px;}
.modal-section p,.modal-section ul{font-size:.88rem;line-height:1.7;color:var(--text);}
.recipe-card{background:#fff;border-radius:10px;padding:13px;margin-bottom:10px;
  border-left:4px solid var(--green-light);box-shadow:0 2px 7px var(--shadow);}
.recipe-card h5{color:var(--green-dark);font-size:.92rem;margin-bottom:5px;}
.recipe-card p{font-size:.83rem;color:var(--text-muted);line-height:1.6;}

/* locations in modal */
.loc-list-item{display:flex;align-items:center;gap:10px;padding:9px 12px;background:#fff;
  border-radius:9px;margin-bottom:7px;border:1px solid var(--green-pale);}
.loc-list-item .loc-info{flex:1;}
.loc-list-item .loc-title{font-weight:700;font-size:.9rem;}
.loc-list-item .loc-coord{font-size:.78rem;color:var(--text-muted);}

/* â”€â”€ SEARCH BAR â”€â”€ */
.search-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;}
.search-bar input{flex:1;min-width:180px;padding:9px 16px;border:2px solid var(--green-pale);
  border-radius:22px;font-family:'Lato',sans-serif;font-size:.92rem;outline:none;}
.search-bar input:focus{border-color:var(--green-mid);}
.search-bar select{padding:9px 14px;border:2px solid var(--green-pale);border-radius:22px;
  font-family:'Lato',sans-serif;font-size:.88rem;outline:none;background:#fff;}

/* â”€â”€ PHOTO â”€â”€ */
.photo-preview{width:100%;height:140px;background:var(--green-pale);border-radius:10px;
  display:flex;align-items:center;justify-content:center;font-size:2.3rem;
  position:relative;overflow:hidden;cursor:pointer;border:2px dashed var(--green-light);transition:background .2s;}
.photo-preview:hover{background:#c8e0b0;}
.photo-preview img{width:100%;height:100%;object-fit:cover;}

/* â”€â”€ REZEPTE â”€â”€ */
.recipe-section-plant{margin-bottom:24px;}
.recipe-section-plant h3{font-family:'Playfair Display',serif;color:var(--green-dark);font-size:1.15rem;margin-bottom:10px;}

/* â”€â”€ EXPORT â”€â”€ */
.export-section{background:linear-gradient(135deg,var(--green-dark),#1a3a08);color:#fff;
  border-radius:var(--radius);padding:22px;margin-top:16px;}
.export-section h3{font-family:'Playfair Display',serif;margin-bottom:8px;font-size:1.15rem;}
.export-section p{font-size:.86rem;opacity:.85;margin-bottom:13px;line-height:1.6;}

/* â”€â”€ STATS â”€â”€ */
.stat-box{background:var(--cream);padding:14px;border-radius:10px;text-align:center;
  box-shadow:0 2px 8px var(--shadow);}
.stat-box .num{font-size:2rem;font-weight:700;font-family:'Playfair Display',serif;}
.stat-box .lbl{font-size:.8rem;color:var(--text-muted);margin-top:3px;}

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty-state{text-align:center;padding:55px 20px;color:var(--text-muted);}
.empty-state .icon{font-size:3.5rem;margin-bottom:14px;}
.empty-state h3{font-family:'Playfair Display',serif;font-size:1.25rem;color:var(--green-dark);margin-bottom:7px;}

/* â”€â”€ NOTIFICATION â”€â”€ */
.notification{position:fixed;bottom:20px;right:20px;background:var(--green-dark);color:#fff;
  padding:11px 18px;border-radius:11px;font-size:.88rem;z-index:9999;display:none;
  box-shadow:0 4px 20px rgba(0,0,0,.3);animation:slideIn .3s ease;}
@keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}

/* â”€â”€ EDIT MODAL TABS â”€â”€ */
.etabs{display:flex;gap:4px;margin-bottom:18px;border-bottom:2px solid var(--green-pale);padding-bottom:0;}
.etab{padding:7px 16px;border:none;border-bottom:3px solid transparent;background:none;
  font-family:'Lato',sans-serif;font-weight:700;font-size:.88rem;cursor:pointer;color:var(--text-muted);
  margin-bottom:-2px;}
.etab.active{color:var(--green-dark);border-bottom-color:var(--green-mid);}
.etab-panel{display:none;}
.etab-panel.active{display:block;}

/* â”€â”€ DB MODAL â”€â”€ */
.db-search-bar{display:flex;gap:8px;margin-bottom:14px;}
.db-search-bar input{flex:1;padding:9px 14px;border:2px solid var(--green-pale);border-radius:22px;
  font-family:'Lato',sans-serif;font-size:.92rem;outline:none;}
.db-search-bar input:focus{border-color:var(--green-mid);}
.db-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;
  max-height:55vh;overflow-y:auto;padding:2px;}
.db-card{background:#fff;border-radius:10px;padding:12px;border:2px solid var(--green-pale);
  cursor:pointer;transition:all .2s;text-align:center;}
.db-card:hover{border-color:var(--green-mid);background:var(--green-pale);transform:translateY(-2px);}
.db-card .db-emoji{font-size:2rem;margin-bottom:6px;}
.db-card .db-name{font-weight:700;font-size:.9rem;color:var(--green-dark);}
.db-card .db-latin{font-style:italic;font-size:.75rem;color:var(--text-muted);}
.db-card .db-cat{font-size:.7rem;padding:2px 8px;border-radius:10px;color:#fff;
  display:inline-block;margin-top:5px;font-weight:700;}

/* â”€â”€ PHOTO EDIT â”€â”€ */
.photo-edit-wrap{position:relative;width:100%;height:140px;border-radius:10px;overflow:hidden;
  border:2px dashed var(--green-light);background:var(--green-pale);display:flex;
  align-items:center;justify-content:center;font-size:2rem;cursor:pointer;transition:background .2s;}
.photo-edit-wrap:hover{background:#c8e0b0;}
.photo-edit-wrap img{width:100%;height:100%;object-fit:cover;}
.photo-edit-btn{position:absolute;bottom:8px;right:8px;background:rgba(45,80,22,.7);color:#fff;
  border:none;border-radius:8px;padding:5px 10px;font-size:.78rem;font-weight:700;cursor:pointer;}
.photo-edit-del{position:absolute;bottom:8px;left:8px;background:rgba(192,57,43,.8);color:#fff;
  border:none;border-radius:8px;padding:5px 10px;font-size:.78rem;font-weight:700;cursor:pointer;}
</style>
</head>
<body>

<header>
  <h1>ğŸŒ¿ Pflanzenfinder <small>Mein KrÃ¤uterbuch</small></h1>
  <div class="header-actions">
    <button class="btn btn-secondary" style="color:#fff;border-color:rgba(255,255,255,.5);font-size:.83rem;" onclick="openDBModal()">ğŸ“š Datenbank</button>
    <button class="btn btn-secondary" style="color:#fff;border-color:rgba(255,255,255,.5);font-size:.83rem;" onclick="openAddModal()">+ Neu</button>
  </div>
</header>

<nav>
  <button class="active" onclick="showSection('uebersicht')">ğŸŒ± Ãœbersicht</button>
  <button onclick="showSection('kalender')">ğŸ“… Kalender</button>
  <button onclick="showSection('karte')">ğŸ—ºï¸ Karte</button>
  <button onclick="showSection('rezepte')">ğŸµ Rezepte</button>
  <button onclick="showSection('export')">ğŸ’¾ Export</button>
</nav>

<main>

<!-- â•â•â•â•â•â•â•â•â•â• ÃœBERSICHT â•â•â•â•â•â•â•â•â•â• -->
<div class="section active" id="section-uebersicht">
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="ğŸ” Pflanze suchen..." oninput="renderPlants()">
    <select id="filterCat" onchange="renderPlants()">
      <option value="">Alle Kategorien</option>
    </select>
    <select id="filterUse" onchange="renderPlants()">
      <option value="">Alle Verwendungen</option>
      <option value="Tee">Tee</option>
      <option value="Salat">Salat</option>
      <option value="Medizin">Medizin</option>
      <option value="Kochen">Kochen</option>
      <option value="Tinkturen">Tinkturen</option>
    </select>
  </div>
  <div class="plants-grid" id="plantsGrid"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• KALENDER â•â•â•â•â•â•â•â•â•â• -->
<div class="section" id="section-kalender">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px;">
    <h2 style="font-family:'Playfair Display',serif;color:var(--green-dark);font-size:1.45rem;">ğŸ“… Ernte- & Fundkalender</h2>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <select id="calFilterCat" onchange="renderCalendar()" style="padding:7px 12px;border:2px solid var(--green-pale);border-radius:22px;font-family:'Lato',sans-serif;outline:none;background:#fff;font-size:.88rem;">
        <option value="">Alle Kategorien</option>
      </select>
    </div>
  </div>
  <div class="cal-wrap">
    <table class="cal-table" id="calTable">
      <thead><tr>
        <th>Pflanze</th>
        <th>Kategorie</th>
        <th>Stadium</th>
        <th class="month-th">Jan</th><th class="month-th">Feb</th><th class="month-th">MÃ¤r</th>
        <th class="month-th">Apr</th><th class="month-th">Mai</th><th class="month-th">Jun</th>
        <th class="month-th">Jul</th><th class="month-th">Aug</th><th class="month-th">Sep</th>
        <th class="month-th">Okt</th><th class="month-th">Nov</th><th class="month-th">Dez</th>
      </tr></thead>
      <tbody id="calBody"></tbody>
    </table>
  </div>
  <div style="margin-top:12px;display:flex;gap:20px;flex-wrap:wrap;">
    <span style="display:flex;align-items:center;gap:6px;font-size:.82rem;color:var(--text-muted);">
      <span style="display:inline-block;width:28px;height:14px;border-radius:7px;background:var(--green-mid)"></span> Haupterntezeit
    </span>
    <span style="display:flex;align-items:center;gap:6px;font-size:.82rem;color:var(--text-muted);">
      <span style="display:inline-block;width:28px;height:14px;border-radius:7px;background:var(--earth-light)"></span> Nebenzeit (Â±1 Monat)
    </span>
    <span style="display:flex;align-items:center;gap:6px;font-size:.82rem;color:var(--text-muted);">
      <span style="display:inline-block;width:28px;height:14px;border-radius:7px;background:#e8e0d0"></span> Nicht verfÃ¼gbar
    </span>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• KARTE â•â•â•â•â•â•â•â•â•â• -->
<div class="section" id="section-karte">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:14px;">
    <h2 style="font-family:'Playfair Display',serif;color:var(--green-dark);font-size:1.45rem;">ğŸ—ºï¸ Fundort-Karte</h2>
  </div>
  <div class="map-controls" id="mapCatFilters">
    <span style="font-size:.85rem;font-weight:700;color:var(--text-muted);">Filter:</span>
    <button class="cat-filter-btn active" data-cat="ALL" onclick="toggleMapCat(this)" style="border-color:var(--green-mid);color:var(--green-mid);">Alle</button>
  </div>
  <div id="mapContainer"></div>
  <p style="margin-top:10px;font-size:.8rem;color:var(--text-muted);">Klicke auf einen Marker fÃ¼r Details. Nur Pflanzen mit GPS-Koordinaten werden angezeigt.</p>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• REZEPTE â•â•â•â•â•â•â•â•â•â• -->
<div class="section" id="section-rezepte">
  <h2 style="font-family:'Playfair Display',serif;color:var(--green-dark);margin-bottom:18px;font-size:1.45rem;">ğŸµ Rezepte & Verwendung</h2>
  <div id="rezepteList"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• EXPORT â•â•â•â•â•â•â•â•â•â• -->
<div class="section" id="section-export">
  <h2 style="font-family:'Playfair Display',serif;color:var(--green-dark);margin-bottom:18px;font-size:1.45rem;">ğŸ’¾ Export & Statistiken</h2>
  <div class="export-section">
    <h3>ğŸŒ Google Earth Export (KML)</h3>
    <p>Alle Fundorte als KML-Datei â€“ direkt in Google Earth oder Google Maps importierbar.</p>
    <button class="btn" style="background:#fff;color:var(--green-dark);font-weight:700;" onclick="exportKML()">â¬‡ï¸ KML herunterladen</button>
  </div>
  <div class="form-card" style="margin-top:18px;">
    <h2>ğŸ“‹ Datensicherung</h2>
    <p style="color:var(--text-muted);margin-bottom:14px;font-size:.88rem;">Exportiere oder importiere alle Pflanzendaten als JSON-Datei.</p>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="exportJSON()">ğŸ’¾ JSON exportieren</button>
      <label class="btn btn-secondary" style="cursor:pointer;">ğŸ“‚ JSON importieren<input type="file" accept=".json" onchange="importJSON(this)" style="display:none;"></label>
    </div>
  </div>
  <div class="form-card" style="margin-top:18px;">
    <h2>ğŸ“Š Statistiken</h2>
    <div id="statsDiv" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:13px;margin-top:12px;"></div>
  </div>
</div>

</main>

<!-- â•â•â•â•â•â•â•â•â•â• DETAIL / EDIT MODAL â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="detailOverlay" onclick="closeOnBg(event,'detailOverlay')">
<div class="modal" id="detailModal">
  <div class="modal-header">
    <div>
      <h2 id="dm_name"></h2>
      <div class="latin" id="dm_latin"></div>
    </div>
    <button class="modal-close" onclick="closeModal('detailOverlay')">âœ•</button>
  </div>
  <div class="modal-body">
    <div class="etabs">
      <button class="etab active" onclick="switchEtab(0)">ğŸ“‹ Info</button>
      <button class="etab" onclick="switchEtab(1)">ğŸ“ Standorte</button>
      <button class="etab" onclick="switchEtab(2)">âœï¸ Bearbeiten</button>
    </div>
    <!-- INFO TAB -->
    <div class="etab-panel active" id="etab0">
      <div id="dm_info"></div>
    </div>
    <!-- STANDORTE TAB -->
    <div class="etab-panel" id="etab1">
      <div id="dm_locs"></div>
    </div>
    <!-- EDIT TAB -->
    <div class="etab-panel" id="etab2">
      <div id="dm_edit"></div>
    </div>
  </div>
</div>
</div>

<!-- ADD MODAL -->
<div class="modal-overlay" id="addOverlay" onclick="closeOnBg(event,'addOverlay')">
<div class="modal">
  <div class="modal-header">
    <div><h2>ğŸŒ± Neue Pflanze</h2></div>
    <button class="modal-close" onclick="closeModal('addOverlay')">âœ•</button>
  </div>
  <div class="modal-body" id="addModalBody">
    <!-- filled by buildAddForm() -->
  </div>
</div>
</div>

<!-- DB MODAL -->
<div class="modal-overlay" id="dbOverlay" onclick="closeOnBg(event,'dbOverlay')">
<div class="modal" style="max-width:760px;">
  <div class="modal-header">
    <div><h2>ğŸ“š Pflanzendatenbank</h2><div class="latin">Pflanze auswÃ¤hlen und automatisch eintragen</div></div>
    <button class="modal-close" onclick="closeModal('dbOverlay')">âœ•</button>
  </div>
  <div class="modal-body">
    <div class="db-search-bar">
      <input type="text" id="dbSearch" placeholder="ğŸ” Pflanze suchen..." oninput="renderDB()">
      <select id="dbCatFilter" onchange="renderDB()" style="padding:9px 13px;border:2px solid var(--green-pale);border-radius:22px;font-family:'Lato',sans-serif;outline:none;background:#fff;font-size:.88rem;">
        <option value="">Alle Kategorien</option>
        <option value="KrÃ¤uter">KrÃ¤uter</option>
        <option value="Wildpflanzen">Wildpflanzen</option>
        <option value="Beeren">Beeren</option>
        <option value="Obst">Obst</option>
        <option value="Heilpflanzen">Heilpflanzen</option>
        <option value="Pilze">Pilze</option>
        <option value="BÃ¤ume">BÃ¤ume</option>
      </select>
    </div>
    <div class="db-grid" id="dbGrid"></div>
  </div>
</div>
</div>

<!-- PWA INSTALL BANNER -->
<div id="installBanner" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:9998;
  background:linear-gradient(135deg,#2d5016,#4a7c2f);color:#fff;padding:14px 20px;
  align-items:center;gap:14px;box-shadow:0 -4px 20px rgba(0,0,0,.3);flex-wrap:wrap;">
  <div style="font-size:1.8rem">ğŸŒ¿</div>
  <div style="flex:1;min-width:200px;">
    <div style="font-weight:700;font-size:.95rem;">Als App installieren</div>
    <div style="font-size:.82rem;opacity:.85;">Offline nutzbar Â· Kein Browser nÃ¶tig Â· Homescreen-Icon</div>
  </div>
  <button id="installBtn" style="padding:9px 20px;background:#fff;color:#2d5016;border:none;
    border-radius:22px;font-weight:700;font-size:.9rem;cursor:pointer;white-space:nowrap;">
    ğŸ“² Installieren
  </button>
  <button id="installDismiss" style="padding:9px 14px;background:rgba(255,255,255,.2);color:#fff;
    border:none;border-radius:22px;font-size:.9rem;cursor:pointer;">âœ•</button>
</div>

<div class="notification" id="notification"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE_KEY = 'pflanzenfinder_v3';
let plants = [];
let categories = ['KrÃ¤uter','Wildpflanzen','Beeren','Obst','Pilze','Heilpflanzen','GemÃ¼se','BÃ¤ume'];
let currentDetailId = null;
let leafletMap = null;
let mapMarkers = [];
let activeCatFilters = new Set(['ALL']);

const CAT_COLORS = {
  'KrÃ¤uter':'#4a7c2f','Wildpflanzen':'#7aab52','Beeren':'#b03060','Obst':'#e07020',
  'Pilze':'#8b4513','Heilpflanzen':'#2e86ab','GemÃ¼se':'#5a9e40','BÃ¤ume':'#6b4423',
};
function catColor(c){ return CAT_COLORS[c] || '#666'; }

function load(){
  try{ const d=localStorage.getItem(STORAGE_KEY); if(d){const p=JSON.parse(d);plants=p.plants||[];categories=p.categories||categories;} }catch(e){}
  if(!plants.length) addSampleData();
}
function save(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify({plants,categories}));
}

function addSampleData(){
  plants=[
    {id:1,name:'Brennnessel',latin:'Urtica dioica',emoji:'ğŸŒ¿',category:'Wildpflanzen',
     stages:['Jungpflanze','Altpflanze'],monStart:3,monEnd:8,
     uses:['Tee','Salat','Medizin'],
     desc:'Bevorzugt stickstoffreiche BÃ¶den. Junge Triebe im FrÃ¼hling ernten.',
     photo:null,
     locations:[{id:1,name:'Waldrand am Bach',lat:52.520,lng:13.405},{id:2,name:'Gartenzaun Nord',lat:52.522,lng:13.408}],
     recipes:[{title:'Brennnessel-Tee',desc:'2 EL BlÃ¤tter, 250ml heiÃŸes Wasser, 10 Min. ziehen lassen.'},{title:'Brennnessel-Suppe',desc:'200g Triebe, 1 Zwiebel, 500ml BrÃ¼he. PÃ¼rieren, wÃ¼rzen.'}]},
    {id:2,name:'Schafgarbe',latin:'Achillea millefolium',emoji:'ğŸŒ¼',category:'Heilpflanzen',
     stages:['Halbwuchs','Altpflanze'],monStart:5,monEnd:9,
     uses:['Tee','Medizin'],
     desc:'Sonnige Magerwiesen. Blutstillend.',
     photo:null,
     locations:[{id:1,name:'Magerwiese SÃ¼dfeld',lat:48.135,lng:11.582}],
     recipes:[{title:'Wundtinktur',desc:'50g BlÃ¼ten in 250ml Korn, 4 Wochen ziehen lassen.'}]},
    {id:3,name:'BÃ¤rlauch',latin:'Allium ursinum',emoji:'ğŸ§„',category:'Wildpflanzen',
     stages:['Jungpflanze','Altpflanze'],monStart:2,monEnd:4,
     uses:['Kochen','Salat'],
     desc:'FrÃ¼hjahrsbote! Vorsicht: nicht mit MaiglÃ¶ckchen verwechseln.',
     photo:null,
     locations:[{id:1,name:'Buchenmischwald feuchte Stelle',lat:50.941,lng:6.958}],
     recipes:[{title:'BÃ¤rlauch-Pesto',desc:'100g BlÃ¤tter, 50g Parmesan, 50g Pinienkerne, 150ml OlivenÃ¶l, Salz.'},{title:'BÃ¤rlauch-Butter',desc:'100g Butter + 3 EL BÃ¤rlauch fein gehackt, vermengen.'}]},
    {id:4,name:'Holunder',latin:'Sambucus nigra',emoji:'ğŸ«',category:'Beeren',
     stages:['Altpflanze','Saatgut'],monStart:6,monEnd:9,
     uses:['Kochen','Tinkturen'],
     desc:'BlÃ¼ten im Juni, Beeren ab August.',
     photo:null,
     locations:[{id:1,name:'Hecke am Feldweg',lat:51.340,lng:12.374}],
     recipes:[{title:'HolunderblÃ¼ten-Sirup',desc:'20 Dolden, 1kg Zucker, 1L Wasser, 2 Zitronen. 24h ziehen lassen, abseihen.'}]},
  ];
  save();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MONTHS = ['Jan','Feb','MÃ¤r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
function notify(msg){
  const n=document.getElementById('notification');
  n.textContent=msg; n.style.display='block';
  setTimeout(()=>n.style.display='none',3000);
}
function escXml(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function closeOnBg(e,id){if(e.target===document.getElementById(id))closeModal(id);}

function showSection(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById('section-'+id).classList.add('active');
  const tabs=['uebersicht','kalender','karte','rezepte','export'];
  document.querySelectorAll('nav button').forEach((b,i)=>b.classList.toggle('active',tabs[i]===id));
  if(id==='uebersicht') renderPlants();
  if(id==='kalender'){updateCatSelects();renderCalendar();}
  if(id==='karte'){updateCatSelects();renderMap();}
  if(id==='rezepte') renderRezepte();
  if(id==='export'){renderStats();}
}

function updateCatSelects(){
  ['filterCat','calFilterCat'].forEach(sid=>{
    const el=document.getElementById(sid); if(!el)return;
    const val=el.value;
    el.innerHTML='<option value="">Alle Kategorien</option>'+categories.map(c=>`<option value="${c}"${c===val?' selected':''}>${c}</option>`).join('');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPlants(){
  updateCatSelects();
  const grid=document.getElementById('plantsGrid');
  const q=document.getElementById('searchInput').value.toLowerCase();
  const cat=document.getElementById('filterCat').value;
  const use=document.getElementById('filterUse').value;
  let list=plants.filter(p=>{
    const mq=!q||p.name.toLowerCase().includes(q)||(p.latin||'').toLowerCase().includes(q);
    const mc=!cat||p.category===cat;
    const mu=!use||(p.uses||[]).includes(use);
    return mq&&mc&&mu;
  });
  if(!list.length){
    grid.innerHTML=`<div class="empty-state" style="grid-column:1/-1"><div class="icon">ğŸŒ±</div><h3>Noch keine Pflanzen</h3><p>Klicke auf â€+ Neu" um deine erste Pflanze hinzuzufÃ¼gen.</p></div>`;
    return;
  }
  grid.innerHTML=list.map(p=>{
    const cc=catColor(p.category||'');
    const locs=p.locations||[];
    return `<div class="plant-card" onclick="openDetail(${p.id})">
      <div class="plant-card-img">
        ${p.photo?`<img src="${p.photo}" alt="${p.name}">`:(p.emoji||'ğŸŒ¿')}
        ${p.category?`<span class="cat-ribbon" style="background:${cc}">${p.category}</span>`:''}
      </div>
      <div class="plant-card-body">
        <h3>${p.name}</h3>
        <div class="latin">${p.latin||''}</div>
        <div class="tags">
          <span class="tag tag-season">â° ${MONTHS[p.monStart||0]}â€“${MONTHS[p.monEnd||11]}</span>
          ${(p.uses||[]).slice(0,2).map(u=>`<span class="tag tag-use">${u}</span>`).join('')}
        </div>
        <div class="loc-count">ğŸ“ ${locs.length} Standort${locs.length!==1?'e':''}</div>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CALENDAR with color bars
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCalendar(){
  const cat=document.getElementById('calFilterCat')?.value||'';
  let list=plants.filter(p=>!cat||p.category===cat);
  const body=document.getElementById('calBody');
  if(!list.length){
    body.innerHTML=`<tr><td colspan="15" style="text-align:center;padding:28px;color:var(--text-muted)">Keine Pflanzen gefunden</td></tr>`;
    return;
  }
  body.innerHTML=list.flatMap(p=>{
    const cc=catColor(p.category||'');
    return (p.stages&&p.stages.length?p.stages:['Altpflanze']).map((stage,si)=>{
      const start=p.monStart||0, end=p.monEnd||11;
      const monthCells=Array.from({length:12},(_,i)=>{
        let fill='0%', color='transparent';
        if(i>=start&&i<=end){ fill='100%'; color=cc; }
        else if(i===start-1||i===end+1){ fill='50%'; color=catColor(p.category||'')+'99'; }
        return `<td class="month-cell">
          <div class="month-bar-wrap">
            <div class="month-bar-fill" style="width:${fill};background:${color};"></div>
          </div>
        </td>`;
      }).join('');
      return `<tr onclick="openDetail(${p.id})" title="Klicken zum Bearbeiten">
        <td>${si===0?`<div class="plant-name-cell">${p.emoji||'ğŸŒ¿'} ${p.name}</div><div class="plant-latin-cell">${p.latin||''}</div>`:''}</td>
        <td>${si===0&&p.category?`<span class="tag tag-cat" style="background:${cc}">${p.category}</span>`:''}</td>
        <td class="stage-cell"><span class="stage-badge stage-${stage.toLowerCase().replace('Ã¤','a')}">${stage}</span></td>
        ${monthCells}
      </tr>`;
    });
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMap(){
  if(!leafletMap){
    leafletMap=L.map('mapContainer').setView([51.1657,10.4515],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'Â© OpenStreetMap',maxZoom:19
    }).addTo(leafletMap);
  }
  // clear
  mapMarkers.forEach(m=>m.remove());
  mapMarkers=[];

  // build category filter buttons
  const fc=document.getElementById('mapCatFilters');
  const allCats=[...new Set(plants.map(p=>p.category).filter(Boolean))];
  // keep ALL button, rebuild rest
  fc.innerHTML=`<span style="font-size:.85rem;font-weight:700;color:var(--text-muted);">Filter:</span>
    <button class="cat-filter-btn ${activeCatFilters.has('ALL')?'active':''}" data-cat="ALL" 
      onclick="toggleMapCat(this)" style="border-color:var(--green-mid);${activeCatFilters.has('ALL')?'background:var(--green-mid);color:#fff;':'color:var(--green-mid);'}">Alle</button>`
    +allCats.map(c=>{
      const col=catColor(c);
      const on=activeCatFilters.has(c)||activeCatFilters.has('ALL');
      return `<button class="cat-filter-btn ${on&&!activeCatFilters.has('ALL')?'active':''}" data-cat="${c}"
        onclick="toggleMapCat(this)" style="border-color:${col};${on&&!activeCatFilters.has('ALL')?`background:${col};color:#fff;`:`color:${col};`}">${c}</button>`;
    }).join('');

  const bounds=[];
  plants.forEach(p=>{
    if(!p.category && !activeCatFilters.has('ALL') && !activeCatFilters.has('')) return;
    if(!activeCatFilters.has('ALL')&&p.category&&!activeCatFilters.has(p.category)) return;
    (p.locations||[]).forEach(loc=>{
      if(!loc.lat||!loc.lng) return;
      const col=catColor(p.category||'');
      const icon=L.divIcon({
        className:'',
        html:`<div style="width:32px;height:32px;background:${col};border:3px solid #fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,.3);cursor:pointer;">${p.emoji||'ğŸŒ¿'}</div>`,
        iconSize:[32,32],iconAnchor:[16,16]
      });
      const m=L.marker([loc.lat,loc.lng],{icon}).addTo(leafletMap);
      m.bindPopup(`<b>${p.emoji||''} ${p.name}</b><br><i>${p.latin||''}</i><br>ğŸ“ ${loc.name||''}<br><span style="font-size:.8rem;color:#666">${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}</span><br><a href="#" onclick="event.preventDefault();openDetail(${p.id})" style="color:var(--green-mid);font-weight:700">Details â†’</a>`);
      mapMarkers.push(m);
      bounds.push([loc.lat,loc.lng]);
    });
  });
  if(bounds.length) leafletMap.fitBounds(bounds,{padding:[30,30],maxZoom:13});
  setTimeout(()=>leafletMap.invalidateSize(),100);
}

function toggleMapCat(btn){
  const cat=btn.dataset.cat;
  if(cat==='ALL'){
    activeCatFilters=new Set(['ALL']);
  } else {
    activeCatFilters.delete('ALL');
    if(activeCatFilters.has(cat)) activeCatFilters.delete(cat);
    else activeCatFilters.add(cat);
    if(!activeCatFilters.size) activeCatFilters.add('ALL');
  }
  renderMap();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REZEPTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRezepte(){
  const div=document.getElementById('rezepteList');
  const wp=plants.filter(p=>p.recipes&&p.recipes.some(r=>r.title));
  if(!wp.length){
    div.innerHTML=`<div class="empty-state"><div class="icon">ğŸµ</div><h3>Noch keine Rezepte</h3><p>FÃ¼ge beim Eintragen einer Pflanze Rezepte hinzu.</p></div>`;
    return;
  }
  div.innerHTML=wp.map(p=>`
    <div class="recipe-section-plant">
      <h3>${p.emoji||'ğŸŒ¿'} ${p.name} <span style="font-size:.8rem;font-style:italic;color:var(--text-muted);font-family:inherit;">${p.latin||''}</span></h3>
      ${p.recipes.filter(r=>r.title).map(r=>`
        <div class="recipe-card">
          <h5>ğŸƒ ${r.title}</h5>
          <p>${r.desc||''}</p>
        </div>`).join('')}
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats(){
  const div=document.getElementById('statsDiv');
  div.innerHTML=[
    {num:plants.length,lbl:'Pflanzen',bg:'var(--green-pale)',col:'var(--green-dark)'},
    {num:plants.filter(p=>p.locations&&p.locations.length).length,lbl:'mit Standorten',bg:'#fff3cd',col:'#856404'},
    {num:plants.flatMap(p=>p.locations||[]).length,lbl:'Standorte gesamt',bg:'#fde8d8',col:'var(--accent)'},
    {num:plants.flatMap(p=>p.recipes||[]).filter(r=>r.title).length,lbl:'Rezepte',bg:'#e8d4f5',col:'#5a1a6b'},
  ].map(s=>`<div class="stat-box" style="background:${s.bg}"><div class="num" style="color:${s.col}">${s.num}</div><div class="lbl">${s.lbl}</div></div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DETAIL MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetail(id){
  currentDetailId=id;
  const p=plants.find(x=>x.id===id); if(!p)return;
  document.getElementById('dm_name').textContent=`${p.emoji||'ğŸŒ¿'} ${p.name}`;
  document.getElementById('dm_latin').textContent=p.latin||'';
  renderDetailInfo(p);
  renderDetailLocs(p);
  renderDetailEdit(p);
  switchEtab(0);
  document.getElementById('detailOverlay').classList.add('open');
}

function switchEtab(i){
  document.querySelectorAll('.etab').forEach((b,j)=>b.classList.toggle('active',i===j));
  document.querySelectorAll('.etab-panel').forEach((p,j)=>p.classList.toggle('active',i===j));
  if(i===1) renderDetailLocs(plants.find(x=>x.id===currentDetailId));
}

function renderDetailInfo(p){
  const cc=catColor(p.category||'');
  document.getElementById('dm_info').innerHTML=`
    ${p.photo?`<img src="${p.photo}" style="width:100%;height:180px;object-fit:cover;border-radius:10px;margin-bottom:16px;">`:''}
    <div class="modal-section">
      <h4>ğŸ·ï¸ Kategorie & Verwendung</h4>
      <div class="tags">
        ${p.category?`<span class="tag tag-cat" style="background:${cc}">${p.category}</span>`:''}
        ${(p.uses||[]).map(u=>`<span class="tag tag-use">${u}</span>`).join('')}
      </div>
    </div>
    <div class="modal-section">
      <h4>ğŸŒ± Pflanzenstadien</h4>
      <div>${(p.stages||[]).map(s=>`<span class="stage-badge stage-${s.toLowerCase().replace('Ã¤','a')}">${s}</span>`).join(' ')}</div>
    </div>
    <div class="modal-section">
      <h4>ğŸ“… Erntezeit</h4>
      <p>${MONTHS[p.monStart||0]} â€“ ${MONTHS[p.monEnd||11]}</p>
    </div>
    ${p.desc?`<div class="modal-section"><h4>ğŸ“ Notizen</h4><p>${p.desc}</p></div>`:''}
    ${p.recipes&&p.recipes.some(r=>r.title)?`
      <div class="modal-section">
        <h4>ğŸµ Rezepte</h4>
        ${p.recipes.filter(r=>r.title).map(r=>`<div class="recipe-card"><h5>${r.title}</h5><p>${r.desc||''}</p></div>`).join('')}
      </div>`:''}
    <div style="margin-top:14px;">
      <button class="btn btn-danger btn-sm" onclick="deletePlant(${p.id})">ğŸ—‘ï¸ Pflanze lÃ¶schen</button>
    </div>`;
}

function renderDetailLocs(p){
  if(!p)return;
  const div=document.getElementById('dm_locs');
  div.innerHTML=`
    <div id="locsList">
      ${(p.locations||[]).length===0?'<p style="color:var(--text-muted);font-size:.88rem;margin-bottom:14px;">Noch keine Standorte eingetragen.</p>':
        (p.locations||[]).map(loc=>`
          <div class="loc-list-item" id="locitem_${loc.id}">
            <div style="font-size:1.4rem">ğŸ“</div>
            <div class="loc-info">
              <div class="loc-title">${loc.name||'Unbenannt'}</div>
              <div class="loc-coord">${loc.lat?loc.lat.toFixed(5):'-'}, ${loc.lng?loc.lng.toFixed(5):'-'}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end;">
              ${loc.lat&&loc.lng?`<button class="btn btn-secondary btn-sm btn-icon" onclick="openMaps(${loc.lat},${loc.lng})">ğŸ—ºï¸ Maps</button>`:''}
              <button class="btn btn-danger btn-sm btn-icon" onclick="removeLoc(${p.id},${loc.id})">ğŸ—‘ï¸</button>
            </div>
          </div>`).join('')}
    </div>
    <div style="margin-top:16px;background:#f0f7e8;border-radius:10px;padding:14px;">
      <strong style="font-size:.88rem;color:var(--green-dark);">+ Neuen Standort hinzufÃ¼gen</strong>
      <div style="margin-top:10px;">
        <input type="text" id="newLocName" placeholder="Name / Beschreibung" style="width:100%;padding:8px 12px;border:2px solid var(--green-pale);border-radius:8px;margin-bottom:8px;font-family:'Lato',sans-serif;font-size:.9rem;outline:none;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
          <input type="number" id="newLocLat" placeholder="Breitengrad (Lat)" step="0.00001" style="padding:8px 12px;border:2px solid var(--green-pale);border-radius:8px;font-family:'Lato',sans-serif;font-size:.9rem;outline:none;">
          <input type="number" id="newLocLng" placeholder="LÃ¤ngengrad (Lng)" step="0.00001" style="padding:8px 12px;border:2px solid var(--green-pale);border-radius:8px;font-family:'Lato',sans-serif;font-size:.9rem;outline:none;">
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-primary btn-sm" onclick="addLocation(${p.id})">âœ… HinzufÃ¼gen</button>
          <button class="gps-btn" onclick="getGPSForLoc()">ğŸ“ GPS ermitteln</button>
        </div>
      </div>
    </div>`;
}

function renderDetailEdit(p){
  const catOpts=categories.map(c=>`<option value="${c}"${p.category===c?' selected':''}>${c}</option>`).join('');
  const hasPhoto=!!p.photo;
  document.getElementById('dm_edit').innerHTML=`
    <div class="form-group">
      <label>Foto</label>
      <div class="photo-edit-wrap" id="e_photoWrap" onclick="document.getElementById('e_photoFile').click()">
        ${hasPhoto?`<img src="${p.photo}" id="e_photoImg" alt="Foto">`:'ğŸ“·'}
        <button class="photo-edit-btn" onclick="event.stopPropagation();document.getElementById('e_photoFile').click()">ğŸ“· Ã„ndern</button>
        ${hasPhoto?`<button class="photo-edit-del" onclick="event.stopPropagation();deleteEditPhoto()">ğŸ—‘ï¸ LÃ¶schen</button>`:''}
        <input type="file" id="e_photoFile" accept="image/*" onchange="previewEditPhoto(this)" style="display:none;">
      </div>
    </div>
    <div class="form-group"><label>Name</label><input id="e_name" value="${p.name||''}"></div>
    <div class="form-group"><label>Lateinisch</label><input id="e_latin" value="${p.latin||''}"></div>
    <div class="form-group"><label>Emoji</label><input id="e_emoji" value="${p.emoji||'ğŸŒ¿'}" style="width:70px;" maxlength="4"></div>
    <div class="form-group">
      <label>Kategorie</label>
      <div class="cat-select-wrap">
        <select id="e_cat">${catOpts}</select>
      </div>
      <div class="cat-add-input">
        <input type="text" id="e_newcat" placeholder="Neue Kategorie hinzufÃ¼gen...">
        <button class="btn btn-earth btn-sm" onclick="addCategory()">+ HinzufÃ¼gen</button>
      </div>
    </div>
    <div class="form-group">
      <label>Pflanzenstadien</label>
      <div class="stage-badges-wrap">
        ${['Jungpflanze','Halbwuchs','Altpflanze','Saatgut'].map(s=>`
          <label class="stage-label"><input type="checkbox" class="e_stage" value="${s}"${(p.stages||[]).includes(s)?' checked':''}>
          <span class="stage-badge stage-${s.toLowerCase().replace('Ã¤','a')}">${s}</span></label>`).join('')}
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Erntestart</label>
        <select id="e_monStart">${MONTHS.map((m,i)=>`<option value="${i}"${i===(p.monStart||0)?' selected':''}>${m}</option>`).join('')}</select>
      </div>
      <div class="form-group"><label>Ernteende</label>
        <select id="e_monEnd">${MONTHS.map((m,i)=>`<option value="${i}"${i===(p.monEnd||11)?' selected':''}>${m}</option>`).join('')}</select>
      </div>
    </div>
    <div class="form-group"><label>Verwendung (Komma-getrennt)</label>
      <input id="e_uses" value="${(p.uses||[]).join(', ')}"></div>
    <div class="form-group"><label>Beschreibung</label>
      <textarea id="e_desc">${p.desc||''}</textarea></div>
    <div class="form-group"><label>Rezept 1 â€“ Titel</label><input id="e_r1t" value="${(p.recipes&&p.recipes[0])?p.recipes[0].title:''}" placeholder="z.B. Tee"></div>
    <div class="form-group"><label>Rezept 1 â€“ Anleitung</label><textarea id="e_r1d">${(p.recipes&&p.recipes[0])?p.recipes[0].desc:''}</textarea></div>
    <div class="form-group"><label>Rezept 2 â€“ Titel</label><input id="e_r2t" value="${(p.recipes&&p.recipes[1])?p.recipes[1].title:''}" placeholder="z.B. Suppe"></div>
    <div class="form-group"><label>Rezept 2 â€“ Anleitung</label><textarea id="e_r2d">${(p.recipes&&p.recipes[1])?p.recipes[1].desc:''}</textarea></div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveEdit()">ğŸ’¾ Speichern</button>
    </div>`;
}

function saveEdit(){
  const p=plants.find(x=>x.id===currentDetailId); if(!p)return;
  p.name=document.getElementById('e_name').value.trim()||p.name;
  p.latin=document.getElementById('e_latin').value.trim();
  p.emoji=document.getElementById('e_emoji').value.trim()||'ğŸŒ¿';
  p.category=document.getElementById('e_cat').value;
  p.stages=[...document.querySelectorAll('.e_stage:checked')].map(c=>c.value);
  p.monStart=parseInt(document.getElementById('e_monStart').value);
  p.monEnd=parseInt(document.getElementById('e_monEnd').value);
  p.uses=document.getElementById('e_uses').value.split(',').map(s=>s.trim()).filter(Boolean);
  p.desc=document.getElementById('e_desc').value.trim();
  const r1t=document.getElementById('e_r1t').value.trim();
  const r2t=document.getElementById('e_r2t').value.trim();
  p.recipes=[
    r1t?{title:r1t,desc:document.getElementById('e_r1d').value.trim()}:null,
    r2t?{title:r2t,desc:document.getElementById('e_r2d').value.trim()}:null,
  ].filter(Boolean);
  // photo: read from img element if present
  const imgEl=document.getElementById('e_photoImg');
  if(imgEl) p.photo=imgEl.src;
  save();
  document.getElementById('dm_name').textContent=`${p.emoji} ${p.name}`;
  notify('âœ… Ã„nderungen gespeichert!');
  renderPlants();
}

function previewEditPhoto(input){
  if(!input.files[0])return;
  const reader=new FileReader();
  reader.onload=e=>{
    const wrap=document.getElementById('e_photoWrap');
    wrap.innerHTML=`<img src="${e.target.result}" id="e_photoImg" alt="Foto">
      <button class="photo-edit-btn" onclick="event.stopPropagation();document.getElementById('e_photoFile').click()">ğŸ“· Ã„ndern</button>
      <button class="photo-edit-del" onclick="event.stopPropagation();deleteEditPhoto()">ğŸ—‘ï¸ LÃ¶schen</button>
      <input type="file" id="e_photoFile" accept="image/*" onchange="previewEditPhoto(this)" style="display:none;">`;
  };
  reader.readAsDataURL(input.files[0]);
}

function deleteEditPhoto(){
  const p=plants.find(x=>x.id===currentDetailId); if(!p)return;
  p.photo=null; save();
  const wrap=document.getElementById('e_photoWrap');
  wrap.innerHTML=`ğŸ“·<button class="photo-edit-btn" onclick="event.stopPropagation();document.getElementById('e_photoFile').click()">ğŸ“· HinzufÃ¼gen</button>
    <input type="file" id="e_photoFile" accept="image/*" onchange="previewEditPhoto(this)" style="display:none;">`;
  renderPlants();
}

function addCategory(){
  const inp=document.getElementById('e_newcat');
  const val=inp.value.trim();
  if(!val){notify('âš ï¸ Bitte Namen eingeben');return;}
  if(!categories.includes(val)) categories.push(val);
  save();
  inp.value='';
  // refresh select
  const p=plants.find(x=>x.id===currentDetailId);
  if(p) renderDetailEdit(p);
  notify(`âœ… Kategorie â€${val}" hinzugefÃ¼gt`);
}

function addLocation(plantId){
  const p=plants.find(x=>x.id===plantId); if(!p)return;
  const name=document.getElementById('newLocName').value.trim();
  const lat=parseFloat(document.getElementById('newLocLat').value);
  const lng=parseFloat(document.getElementById('newLocLng').value);
  if(!name&&!lat){notify('âš ï¸ Bitte Name oder Koordinaten eingeben');return;}
  if(!p.locations) p.locations=[];
  p.locations.push({id:Date.now(),name,lat:isNaN(lat)?null:lat,lng:isNaN(lng)?null:lng});
  save();
  renderDetailLocs(p);
  notify('ğŸ“ Standort hinzugefÃ¼gt!');
}

function removeLoc(plantId,locId){
  const p=plants.find(x=>x.id===plantId); if(!p)return;
  p.locations=(p.locations||[]).filter(l=>l.id!==locId);
  save();
  renderDetailLocs(p);
  notify('ğŸ—‘ï¸ Standort entfernt');
}

function getGPSForLoc(){
  if(!navigator.geolocation){notify('GPS nicht verfÃ¼gbar');return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    document.getElementById('newLocLat').value=pos.coords.latitude.toFixed(6);
    document.getElementById('newLocLng').value=pos.coords.longitude.toFixed(6);
    notify('ğŸ“ Position ermittelt!');
  },()=>notify('GPS-Zugriff verweigert'));
}

function deletePlant(id){
  if(!confirm('Pflanze wirklich lÃ¶schen?'))return;
  plants=plants.filter(p=>p.id!==id);
  save();
  closeModal('detailOverlay');
  renderPlants();
  notify('ğŸ—‘ï¸ Pflanze gelÃ¶scht');
}

function openMaps(lat,lng){
  window.open(`https://www.google.com/maps?q=${lat},${lng}`,'_blank');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADD FORM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddModal(){
  buildAddForm();
  document.getElementById('addOverlay').classList.add('open');
}

function buildAddForm(){
  const catOpts=categories.map(c=>`<option value="${c}">${c}</option>`).join('');
  document.getElementById('addModalBody').innerHTML=`
    <div class="form-group">
      <label>Foto</label>
      <div class="photo-preview" id="ap_photoPreview" onclick="document.getElementById('ap_photoFile').click()">
        ğŸ“·<input type="file" id="ap_photoFile" accept="image/*" onchange="previewAddPhoto(this)" style="position:absolute;inset:0;opacity:0;cursor:pointer;">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Name *</label><input id="ap_name" placeholder="z.B. Brennnessel"></div>
      <div class="form-group"><label>Lateinisch</label><input id="ap_latin" placeholder="z.B. Urtica dioica"></div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Kategorie</label>
        <select id="ap_cat">${catOpts}</select>
        <div class="cat-add-input">
          <input type="text" id="ap_newcat" placeholder="Neue Kategorie...">
          <button class="btn btn-earth btn-sm" onclick="addCatFromAdd()">+</button>
        </div>
      </div>
      <div class="form-group"><label>Emoji</label><input id="ap_emoji" placeholder="ğŸŒ¿" maxlength="4" style="width:80px;"></div>
    </div>
    <div class="form-group">
      <label>Pflanzenstadien</label>
      <div class="stage-badges-wrap">
        ${['Jungpflanze','Halbwuchs','Altpflanze','Saatgut'].map(s=>`
          <label class="stage-label"><input type="checkbox" class="ap_stage" value="${s}">
          <span class="stage-badge stage-${s.toLowerCase().replace('Ã¤','a')}">${s}</span></label>`).join('')}
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Erntestart</label>
        <select id="ap_monStart">${MONTHS.map((m,i)=>`<option value="${i}"${i===4?' selected':''}>${m}</option>`).join('')}</select>
      </div>
      <div class="form-group"><label>Ernteende</label>
        <select id="ap_monEnd">${MONTHS.map((m,i)=>`<option value="${i}"${i===7?' selected':''}>${m}</option>`).join('')}</select>
      </div>
    </div>
    <div class="form-group"><label>Verwendung (Komma-getrennt)</label>
      <input id="ap_uses" placeholder="z.B. Tee, Salat, Medizin"></div>
    <div class="form-group"><label>Erster Standort (Name)</label>
      <input id="ap_locName" placeholder="z.B. Waldrand am Bach"></div>
    <div class="form-row">
      <div class="form-group"><label>Breitengrad</label><input type="number" id="ap_lat" placeholder="z.B. 52.5200" step="0.00001"></div>
      <div class="form-group"><label>LÃ¤ngengrad</label><input type="number" id="ap_lng" placeholder="z.B. 13.4050" step="0.00001"></div>
    </div>
    <button class="gps-btn" onclick="getGPSAdd()">ğŸ“ GPS ermitteln</button>
    <div class="form-group" style="margin-top:16px;"><label>Beschreibung</label><textarea id="ap_desc" placeholder="Notizen, Erkennungsmerkmale..."></textarea></div>
    <div class="form-group"><label>Rezept 1 â€“ Titel</label><input id="ap_r1t" placeholder="z.B. Tee"></div>
    <div class="form-group"><label>Rezept 1 â€“ Anleitung</label><textarea id="ap_r1d" placeholder="Zubereitung..."></textarea></div>
    <div class="form-group"><label>Rezept 2 â€“ Titel</label><input id="ap_r2t" placeholder="z.B. Suppe"></div>
    <div class="form-group"><label>Rezept 2 â€“ Anleitung</label><textarea id="ap_r2d" placeholder="Zubereitung..."></textarea></div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveNewPlant()">âœ… Pflanze speichern</button>
      <button class="btn btn-secondary" onclick="closeModal('addOverlay')">Abbrechen</button>
    </div>`;
}

function addCatFromAdd(){
  const val=document.getElementById('ap_newcat').value.trim();
  if(!val)return;
  if(!categories.includes(val)) categories.push(val);
  save();
  document.getElementById('ap_newcat').value='';
  // refresh select
  const sel=document.getElementById('ap_cat');
  sel.innerHTML=categories.map(c=>`<option value="${c}"${c===val?' selected':''}>${c}</option>`).join('');
  notify(`âœ… Kategorie â€${val}" hinzugefÃ¼gt`);
}

function previewAddPhoto(input){
  if(!input.files[0])return;
  const reader=new FileReader();
  reader.onload=e=>{
    const prev=document.getElementById('ap_photoPreview');
    prev.innerHTML=`<img src="${e.target.result}" alt="Vorschau"><input type="file" id="ap_photoFile" accept="image/*" onchange="previewAddPhoto(this)" style="position:absolute;inset:0;opacity:0;cursor:pointer;">`;
  };
  reader.readAsDataURL(input.files[0]);
}

function getGPSAdd(){
  if(!navigator.geolocation){notify('GPS nicht verfÃ¼gbar');return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    document.getElementById('ap_lat').value=pos.coords.latitude.toFixed(6);
    document.getElementById('ap_lng').value=pos.coords.longitude.toFixed(6);
    notify('ğŸ“ Position ermittelt!');
  },()=>notify('GPS-Zugriff verweigert'));
}

function saveNewPlant(){
  const name=document.getElementById('ap_name').value.trim();
  if(!name){notify('âš ï¸ Bitte Namen eingeben');return;}
  const lat=parseFloat(document.getElementById('ap_lat').value);
  const lng=parseFloat(document.getElementById('ap_lng').value);
  const locName=document.getElementById('ap_locName').value.trim();
  const stages=[...document.querySelectorAll('.ap_stage:checked')].map(c=>c.value);
  const photoEl=document.querySelector('#ap_photoPreview img');
  const r1t=document.getElementById('ap_r1t').value.trim();
  const r2t=document.getElementById('ap_r2t').value.trim();
  plants.push({
    id:Date.now(),name,
    latin:document.getElementById('ap_latin').value.trim(),
    emoji:document.getElementById('ap_emoji').value.trim()||'ğŸŒ¿',
    category:document.getElementById('ap_cat').value,
    stages:stages.length?stages:['Altpflanze'],
    monStart:parseInt(document.getElementById('ap_monStart').value),
    monEnd:parseInt(document.getElementById('ap_monEnd').value),
    uses:document.getElementById('ap_uses').value.split(',').map(s=>s.trim()).filter(Boolean),
    desc:document.getElementById('ap_desc').value.trim(),
    photo:photoEl?photoEl.src:null,
    locations:(locName||(!isNaN(lat)&&!isNaN(lng)))?[{id:Date.now(),name:locName,lat:isNaN(lat)?null:lat,lng:isNaN(lng)?null:lng}]:[],
    recipes:[
      r1t?{title:r1t,desc:document.getElementById('ap_r1d').value.trim()}:null,
      r2t?{title:r2t,desc:document.getElementById('ap_r2d').value.trim()}:null,
    ].filter(Boolean)
  });
  save();
  closeModal('addOverlay');
  renderPlants();
  notify(`âœ… ${name} gespeichert!`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportKML(){
  const allLocs=plants.flatMap(p=>(p.locations||[]).map(l=>({...l,plant:p})));
  const gps=allLocs.filter(l=>l.lat&&l.lng);
  if(!gps.length){notify('âš ï¸ Keine GPS-Koordinaten vorhanden');return;}
  const placemarks=gps.map(l=>`
  <Placemark>
    <name>${escXml(l.plant.name)} â€“ ${escXml(l.name||'Standort')}</name>
    <description><![CDATA[
      <b>${l.plant.name}</b> (${l.plant.latin||''})<br>
      Kategorie: ${l.plant.category||''}<br>
      Standort: ${l.name||''}<br>
      Erntezeit: ${MONTHS[l.plant.monStart||0]}â€“${MONTHS[l.plant.monEnd||11]}<br>
      Verwendung: ${(l.plant.uses||[]).join(', ')}
    ]]></description>
    <Point><coordinates>${l.lng},${l.lat},0</coordinates></Point>
  </Placemark>`).join('');
  const kml=`<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n  <Document>\n    <name>Pflanzenfinder</name>${placemarks}\n  </Document>\n</kml>`;
  download('pflanzenfundorte.kml',kml,'application/vnd.google-earth.kml+xml');
  notify(`ğŸŒ ${gps.length} Standorte exportiert!`);
}

function exportJSON(){
  download('pflanzenfinder_backup.json',JSON.stringify({plants,categories},null,2),'application/json');
  notify('ğŸ’¾ Daten exportiert!');
}

function importJSON(input){
  const file=input.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(data.plants){plants=data.plants;if(data.categories)categories=data.categories;}
      else if(Array.isArray(data))plants=data;
      else{notify('âš ï¸ UngÃ¼ltiges Format');return;}
      save();renderPlants();updateCatSelects();
      notify(`âœ… ${plants.length} Pflanzen importiert!`);
    }catch{notify('âš ï¸ Datei konnte nicht gelesen werden');}
  };
  reader.readAsText(file);
}

function download(filename,text,type){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([text],{type}));
  a.download=filename;a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLANT DATABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLANT_DB = [
  // KRÃ„UTER
  {name:'Basilikum',latin:'Ocimum basilicum',emoji:'ğŸŒ¿',category:'KrÃ¤uter',stages:['Jungpflanze','Altpflanze'],monStart:4,monEnd:8,uses:['Kochen','Tee'],desc:'WÃ¤rmeliebendes Kraut. Ideal fÃ¼r Tomatengerichte. Nicht in der Sonne gieÃŸen.',recipes:[{title:'Pesto Genovese',desc:'50g Basilikum, 2 Knoblauchzehen, 30g Parmesan, 30g Pinienkerne, 80ml OlivenÃ¶l â€“ alles fein mixen.'},{title:'Tomaten-Basilikum-Salat',desc:'Tomaten in Scheiben, frisches Basilikum, OlivenÃ¶l, Salz, Balsamico.'}]},
  {name:'Thymian',latin:'Thymus vulgaris',emoji:'ğŸŒ±',category:'KrÃ¤uter',stages:['Halbwuchs','Altpflanze'],monStart:4,monEnd:9,uses:['Kochen','Medizin','Tee'],desc:'MehrjÃ¤hriges WÃ¼rzkraut. Bevorzugt sonnige, trockene Standorte.',recipes:[{title:'Thymian-Tee',desc:'1 TL frische Zweige, 200ml heiÃŸes Wasser, 8 Min. ziehen. Gut bei Husten und ErkÃ¤ltung.'},{title:'KrÃ¤uterbutter',desc:'100g Butter, 2 EL Thymian, 1 Knoblauchzehe, Zitronenschale â€“ gut vermengen.'}]},
  {name:'Rosmarin',latin:'Salvia rosmarinus',emoji:'ğŸŒ¿',category:'KrÃ¤uter',stages:['Halbwuchs','Altpflanze'],monStart:3,monEnd:10,uses:['Kochen','Medizin'],desc:'ImmergrÃ¼ner Halbstrauch. Sehr aromatisch. Frostempfindlich unter -10Â°C.',recipes:[{title:'Rosmarinkartoffeln',desc:'Kartoffeln halbieren, mit OlivenÃ¶l, grobem Salz und Rosmarinzweigen bei 200Â°C 40 Min. rÃ¶sten.'},{title:'Rosmarin-Ã–l',desc:'Frische Zweige in eine Flasche OlivenÃ¶l geben, 2 Wochen ziehen lassen.'}]},
  {name:'Salbei',latin:'Salvia officinalis',emoji:'ğŸŒ¿',category:'KrÃ¤uter',stages:['Halbwuchs','Altpflanze'],monStart:4,monEnd:8,uses:['Kochen','Medizin','Tee'],desc:'Halbstrauch. Antibakteriell. Hilft bei Halsschmerzen und Ã¼bermÃ¤ÃŸigem Schwitzen.',recipes:[{title:'Salbei-Tee',desc:'3â€“5 frische BlÃ¤tter mit heiÃŸem Wasser Ã¼bergieÃŸen, 5â€“7 Min. ziehen. Gegen Halsschmerzen gurgeln.'},{title:'Saltimbocca-Butter',desc:'Butter in der Pfanne erhitzen, SalbeiblÃ¤tter darin knusprig braten.'}]},
  {name:'Pfefferminze',latin:'Mentha Ã— piperita',emoji:'ğŸŒ¿',category:'KrÃ¤uter',stages:['Jungpflanze','Altpflanze'],monStart:4,monEnd:9,uses:['Tee','Medizin','Kochen'],desc:'Stark wÃ¼chsig â€“ am besten in TÃ¶pfen halten. Bevorzugt feuchte, halbschattige Standorte.',recipes:[{title:'Pfefferminztee',desc:'1 EL frische BlÃ¤tter mit 250ml kochendem Wasser, 5 Min. ziehen. Magenschonend und kÃ¼hlend.'},{title:'Minzsirup',desc:'500ml Wasser + 500g Zucker aufkochen, 30 frische BlÃ¤tter dazu, 30 Min. ziehen, abseihen.'}]},
  {name:'Oregano',latin:'Origanum vulgare',emoji:'ğŸŒ¿',category:'KrÃ¤uter',stages:['Halbwuchs','Altpflanze'],monStart:5,monEnd:9,uses:['Kochen','Medizin'],desc:'MehrjÃ¤hrig, liebt sonnige Kalkstandorte. Pizza- und Pastakraut par excellence.',recipes:[{title:'Pizza-TomatensoÃŸe',desc:'Dosentomaten, 2 EL Oregano, Knoblauch, OlivenÃ¶l, Salz â€“ 15 Min. kÃ¶cheln lassen.'},{title:'Oregano-Tinktur',desc:'50g frische BlÃ¼ten in 200ml Hochprozentigem, 3 Wochen dunkel stellen.'}]},
  {name:'Schnittlauch',latin:'Allium schoenoprasum',emoji:'ğŸ¥¬',category:'KrÃ¤uter',stages:['Jungpflanze','Altpflanze'],monStart:2,monEnd:10,uses:['Kochen','Salat'],desc:'Sehr pflegeleicht. VertrÃ¤gt Halbschatten. BlÃ¼ten sind ebenfalls essbar.',recipes:[{title:'Schnittlauch-Quark',desc:'250g Quark, 3 EL Schnittlauch, Salz, Pfeffer â€“ als Brotaufstrich oder Dip.'},{title:'KrÃ¤uter-Pfannkuchen',desc:'Normale Pfannkuchen mit 2 EL Schnittlauch im Teig, herzhaft servieren.'}]},
  {name:'Petersilie',latin:'Petroselinum crispum',emoji:'ğŸŒ¿',category:'KrÃ¤uter',stages:['Jungpflanze','Altpflanze'],monStart:3,monEnd:10,uses:['Kochen','Salat','Medizin'],desc:'ZweijÃ¤hrig. Reich an Vitamin C und Eisen. GlattblÃ¤ttrige Sorten aromatischer.',recipes:[{title:'Gremolata',desc:'Petersilie, Knoblauch, Zitronenschale fein hacken â€“ passt zu Ossobuco und Grillgerichten.'},{title:'TaboulÃ©',desc:'Bulgur, viel frische Petersilie, Tomaten, Gurke, Zitronensaft, OlivenÃ¶l, Minze.'}]},
  {name:'Koriander',latin:'Coriandrum sativum',emoji:'ğŸŒ¿',category:'KrÃ¤uter',stages:['Jungpflanze','Altpflanze'],monStart:4,monEnd:8,uses:['Kochen'],desc:'EinjÃ¤hrig. Schnell schossend bei Hitze. Samen und BlÃ¤tter verwendbar.',recipes:[{title:'Guacamole',desc:'2 Avocados, Limette, 1 Knoblauch, Tomate, frischer Koriander, Salz, Chili â€“ grob stampfen.'},{title:'Koriandersamen-GewÃ¼rzmischung',desc:'Samen rÃ¶sten und mahlen fÃ¼r Curries, Fleisch und Marinaden.'}]},
  {name:'Dill',latin:'Anethum graveolens',emoji:'ğŸŒ¿',category:'KrÃ¤uter',stages:['Jungpflanze','Altpflanze','Saatgut'],monStart:4,monEnd:8,uses:['Kochen','Salat'],desc:'EinjÃ¤hrig. VertrÃ¤gt sich nicht gut mit Fenchel (nicht nebeneinander pflanzen).',recipes:[{title:'Gurken-Dill-Salat',desc:'Gurken hobeln, salzen, 30 Min. ziehen, mit Essig, Dill, Zucker und Schmand anmachen.'},{title:'RÃ¤ucherlachs-Dip',desc:'FrischkÃ¤se, RÃ¤ucherlachs, frischer Dill, Zitronensaft â€“ cremig mixen.'}]},
  {name:'Bohnenkraut',latin:'Satureja hortensis',emoji:'ğŸŒ¿',category:'KrÃ¤uter',stages:['Jungpflanze','Altpflanze'],monStart:5,monEnd:9,uses:['Kochen','Medizin'],desc:'EinjÃ¤hrig, sehr aromatisch. Klassisches Bohnen-Kraut. VerdauungsfÃ¶rdernd.',recipes:[{title:'Bohneneintopf',desc:'GrÃ¼ne Bohnen immer mit Bohnenkraut kochen â€“ verhindert BlÃ¤hungen und verfeinert den Geschmack.'}]},
  {name:'Lavendel',latin:'Lavandula angustifolia',emoji:'ğŸ’œ',category:'KrÃ¤uter',stages:['Halbwuchs','Altpflanze'],monStart:5,monEnd:7,uses:['Medizin','Tee','Kochen'],desc:'MehrjÃ¤hrig, liebt Sonne und Kalk. Beruhigend und entspannend.',recipes:[{title:'Lavendel-Lemonade',desc:'1 EL LavendelblÃ¼ten mit 500ml Wasser und 4 EL Honig aufkochen, abkÃ¼hlen, Zitronensaft dazu.'},{title:'Lavendel-Schlafkissen',desc:'Getrocknete BlÃ¼ten in ein kleines LeinensÃ¤ckchen fÃ¼llen â€“ hilft beim Einschlafen.'}]},
  // WILDPFLANZEN
  {name:'LÃ¶wenzahn',latin:'Taraxacum officinale',emoji:'ğŸŒ¼',category:'Wildpflanzen',stages:['Jungpflanze','Altpflanze','Saatgut'],monStart:2,monEnd:9,uses:['Salat','Tee','Medizin','Kochen'],desc:'Ãœberall. Junge BlÃ¤tter im FrÃ¼hling am besten. Alle Pflanzenteile essbar. Entgiftend.',recipes:[{title:'LÃ¶wenzahn-Salat',desc:'Junge BlÃ¤tter, Speck-Dressing mit Essig und Speck, gekochtes Ei â€“ Bitterstoffreicher FrÃ¼hlingssalat.'},{title:'LÃ¶wenzahn-Honig',desc:'100 BlÃ¼ten, 500ml Wasser, 1 Zitrone â€“ aufkochen, 12h ziehen, abseihen, mit 500g Zucker einkÃ¶cheln.'}]},
  {name:'GÃ¤nseblÃ¼mchen',latin:'Bellis perennis',emoji:'ğŸŒ¸',category:'Wildpflanzen',stages:['Jungpflanze','Altpflanze'],monStart:2,monEnd:10,uses:['Salat','Medizin','Kochen'],desc:'GanzjÃ¤hrig blÃ¼hend. Zarte BlÃ¼ten und BlÃ¤tter essbar. Wundheilend.',recipes:[{title:'BlÃ¼tensalat',desc:'Gemischter Salat mit frischen GÃ¤nseblÃ¼mchenblÃ¼ten garnieren â€“ optisch und geschmacklich.'},{title:'GÃ¤nseblÃ¼mchen-Tinktur',desc:'BlÃ¼ten in OlivenÃ¶l einlegen, 4 Wochen, fÃ¼r Hautpflege und Wunden.'}]},
  {name:'Spitzwegerich',latin:'Plantago lanceolata',emoji:'ğŸŒ¿',category:'Wildpflanzen',stages:['Jungpflanze','Altpflanze'],monStart:3,monEnd:9,uses:['Medizin','Tee'],desc:'WegrÃ¤nder, Wiesen. Hustenlindernd. BlÃ¤tter roh auf Insektenstiche legen.',recipes:[{title:'Spitzwegerich-Sirup',desc:'200g BlÃ¤tter + 300ml Wasser + 200g Honig aufkochen, abseihen. Gegen Husten 3x tÃ¤glich 1 TL.'},{title:'Wundsalbe',desc:'BlÃ¤tter in geschmolzenem Bienenwachs und OlivenÃ¶l einkochen, abseihen, abkÃ¼hlen lassen.'}]},
  {name:'Gundelrebe',latin:'Glechoma hederacea',emoji:'ğŸŒ¿',category:'Wildpflanzen',stages:['Jungpflanze','Altpflanze'],monStart:2,monEnd:5,uses:['Tee','Medizin','Salat'],desc:'Schattiger Boden, hÃ¤ufig. SchleimlÃ¶send. Frisch im FrÃ¼hjahr ernten.',recipes:[{title:'Gundelreben-Tee',desc:'2 EL frische BlÃ¤tter, 250ml heiÃŸes Wasser, 8 Min. ziehen. SchleimlÃ¶send und entzÃ¼ndungshemmend.'}]},
  {name:'Giersch',latin:'Aegopodium podagraria',emoji:'ğŸŒ¿',category:'Wildpflanzen',stages:['Jungpflanze','Altpflanze'],monStart:3,monEnd:7,uses:['Salat','Kochen','Medizin'],desc:'Gartenpest mit Nutzen! Junge BlÃ¤tter schmecken wie Petersilie. Sehr ertragreich.',recipes:[{title:'Giersch-Pesto',desc:'100g junge BlÃ¤tter, 30g Parmesan, 2 Knoblauch, 50ml OlivenÃ¶l, 20g WalnÃ¼sse â€“ mixen.'},{title:'Giersch-Spinat',desc:'Wie Spinat zubereiten: kurz in Butter dÃ¼nsten, mit Knoblauch und Muskat wÃ¼rzen.'}]},
  {name:'WiesenbÃ¤renklau',latin:'Heracleum sphondylium',emoji:'ğŸŒ¿',category:'Wildpflanzen',stages:['Jungpflanze','Halbwuchs'],monStart:3,monEnd:6,uses:['Kochen','Salat'],desc:'Nicht mit dem giftigen Riesen-BÃ¤renklau verwechseln! Junge Triebe und BlÃ¤tter verwenden.',recipes:[{title:'BÃ¤renklau-GemÃ¼se',desc:'Junge Triebe wie Spinat zubereiten oder roh im Salat. Nur kurz blanchieren.'}]},
  {name:'Vogelmiere',latin:'Stellaria media',emoji:'ğŸŒ¿',category:'Wildpflanzen',stages:['Jungpflanze','Altpflanze'],monStart:1,monEnd:11,uses:['Salat','Medizin'],desc:'Fast ganzjÃ¤hrig. Reich an Vitamin C. Zart und mildaromatisch.',recipes:[{title:'Vogelmiere-Salat',desc:'Frisch geerntet mit OlivenÃ¶l, Zitrone und Salz. Als Salatbett oder Beilage.'}]},
  {name:'Taubnessel',latin:'Lamium album',emoji:'ğŸ¤',category:'Wildpflanzen',stages:['Jungpflanze','Altpflanze'],monStart:2,monEnd:9,uses:['Tee','Medizin','Salat'],desc:'Nicht verwandt mit der Brennnessel â€“ brennt nicht! BlÃ¼ten und junge BlÃ¤tter essbar.',recipes:[{title:'Taubnessel-Tee',desc:'2 EL BlÃ¼ten und BlÃ¤tter, 250ml heiÃŸes Wasser, 10 Min. ziehen. EntzÃ¼ndungshemmend.'}]},
  // HEILPFLANZEN
  {name:'Johanniskraut',latin:'Hypericum perforatum',emoji:'ğŸŒ»',category:'Heilpflanzen',stages:['Halbwuchs','Altpflanze'],monStart:5,monEnd:8,uses:['Medizin','Tee','Tinkturen'],desc:'Sonnige Standorte. Stimmungsaufhellend â€“ Wechselwirkungen mit Medikamenten mÃ¶glich!',recipes:[{title:'Johanniskraut-Ã–l (RotÃ¶l)',desc:'Frische BlÃ¼ten in OlivenÃ¶l einlegen (Glas vollpacken), 6 Wochen in der Sonne stehen lassen. FÃ¼r Muskeln und Narben.'},{title:'Johanniskraut-Tinktur',desc:'Frische BlÃ¼ten in Alkohol (mind. 45%) einlegen, 4â€“6 Wochen dunkel, abseihen.'}]},
  {name:'Kamille',latin:'Matricaria chamomilla',emoji:'ğŸŒ¼',category:'Heilpflanzen',stages:['Jungpflanze','Altpflanze','Saatgut'],monStart:4,monEnd:8,uses:['Tee','Medizin'],desc:'Sandig-lehmige BÃ¶den. ApfelÃ¤hnlicher Geruch. EntzÃ¼ndungshemmend, beruhigend.',recipes:[{title:'Kamillen-Tee',desc:'1 EL frische oder getrocknete BlÃ¼ten, 250ml heiÃŸes Wasser, 5â€“10 Min. abgedeckt ziehen.'},{title:'Kamillen-Dampfbad',desc:'Handvoll BlÃ¼ten in eine SchÃ¼ssel heiÃŸes Wasser, Kopf mit Tuch abdecken, 10 Min. dÃ¤mpfen.'}]},
  {name:'Baldrian',latin:'Valeriana officinalis',emoji:'ğŸŒ¸',category:'Heilpflanzen',stages:['Jungpflanze','Altpflanze'],monStart:5,monEnd:7,uses:['Medizin','Tee'],desc:'Feuchte Standorte. Wurzel im Herbst ernten. Starkes Beruhigungs- und Schlafmittel.',recipes:[{title:'Baldrian-Tee',desc:'1 TL frisch geriebene Wurzel, 200ml lauwarmes Wasser (nicht kochen!), 8â€“12h kalt ansetzen, abseihen.'},{title:'Baldrian-Tinktur',desc:'Zerkleinerte Wurzel in Alkohol 4 Wochen ziehen lassen. Abends 20â€“30 Tropfen in Wasser.'}]},
  {name:'Ringelblume',latin:'Calendula officinalis',emoji:'ğŸŸ ',category:'Heilpflanzen',stages:['Jungpflanze','Altpflanze','Saatgut'],monStart:5,monEnd:10,uses:['Medizin','Kochen'],desc:'Sehr langblÃ¼hend. Wundheilend, antiseptisch. BlÃ¼tenblÃ¤tter als Safranersatz.',recipes:[{title:'Ringelblumensalbe',desc:'50g BlÃ¼ten in 200ml OlivenÃ¶l bei 50Â°C 3h erwÃ¤rmen, abseihen, mit 20g Bienenwachs aufschmelzen, abfÃ¼llen.'},{title:'Ringelblumentee',desc:'2 EL frische BlÃ¼ten, 250ml heiÃŸes Wasser, 10 Min. ziehen. Ã„uÃŸerlich als Kompresse.'}]},
  {name:'Echinacea (Sonnenhut)',latin:'Echinacea purpurea',emoji:'ğŸ’œ',category:'Heilpflanzen',stages:['Jungpflanze','Altpflanze'],monStart:6,monEnd:9,uses:['Medizin','Tee'],desc:'ImmunstÃ¤rkend. Besonders Wurzel und BlÃ¼ten verwenden. Nicht dauerhaft einnehmen.',recipes:[{title:'ImmunstÃ¤rkungs-Tee',desc:'1 EL BlÃ¼ten und BlÃ¤tter, 250ml heiÃŸes Wasser, 10 Min. ziehen. Nur kurÂ­weise 2 Wochen.'},{title:'Echinacea-Tinktur',desc:'Frische BlÃ¼ten und Wurzelteile in 60% Alkohol, 4 Wochen ziehen, abseihen.'}]},
  {name:'Echter Alant',latin:'Inula helenium',emoji:'ğŸŒ»',category:'Heilpflanzen',stages:['Altpflanze'],monStart:6,monEnd:9,uses:['Medizin','Tee'],desc:'Feuchte Standorte. Starkes Husten- und Bronchialmittel. Wurzel im Herbst ernten.',recipes:[{title:'Alant-Wurzel-Tee',desc:'1 TL geriebene Wurzel in 300ml Wasser 10 Min. kÃ¶cheln, abseihen. Gegen Bronchitis.'}]},
  // BEEREN
  {name:'Wilde Erdbeere',latin:'Fragaria vesca',emoji:'ğŸ“',category:'Beeren',stages:['Jungpflanze','Altpflanze'],monStart:4,monEnd:8,uses:['Kochen','Salat','Medizin'],desc:'WaldrÃ¤nder und Lichtungen. FrÃ¼chte, BlÃ¤tter und Wurzeln verwendbar.',recipes:[{title:'Walderdbeeren-Marmelade',desc:'500g FrÃ¼chte, 250g Gelierzucker 2:1, Zitronensaft â€“ aufkochen, 4 Min. sprudelnd kochen, GlÃ¤ser fÃ¼llen.'},{title:'Erdbeer-Blatt-Tee',desc:'2 EL getrocknete BlÃ¤tter mit heiÃŸem Wasser â€“ mild nierenwirksam.'}]},
  {name:'Schwarze Johannisbeere',latin:'Ribes nigrum',emoji:'ğŸ«',category:'Beeren',stages:['Halbwuchs','Altpflanze'],monStart:6,monEnd:7,uses:['Kochen','Tee','Medizin'],desc:'Feuchte Standorte, halbschattig. Sehr viel Vitamin C.',recipes:[{title:'Johannisbeer-Gelee',desc:'1 kg Beeren entsaften, mit 500g Gelierzucker 1:1 kochen, abschÃ¤umen, in GlÃ¤ser fÃ¼llen.'},{title:'Cassis-LikÃ¶r',desc:'500g Beeren, 500g Zucker, 1L Rotwein, 200ml Wodka â€“ 1 Monat ziehen, abseihen.'}]},
  {name:'Rote Johannisbeere',latin:'Ribes rubrum',emoji:'ğŸ”´',category:'Beeren',stages:['Halbwuchs','Altpflanze'],monStart:5,monEnd:7,uses:['Kochen'],desc:'Anspruchslos. Sehr saftig und sauer. Gut fÃ¼r Gelee und Saft.',recipes:[{title:'Johannisbeer-Saft',desc:'Beeren erhitzen, durch Tuch pressen, mit Zucker nach Geschmack einkochen.'},{title:'Rote-GrÃ¼tze',desc:'500g Beeren + 300ml Saft + 4 EL Zucker + 3 EL StÃ¤rke â€“ einkochen bis dicklich.'}]},
  {name:'Schlehe',latin:'Prunus spinosa',emoji:'ğŸ«',category:'Beeren',stages:['Altpflanze'],monStart:9,monEnd:11,uses:['Kochen','Tinkturen','Medizin'],desc:'Hecken und WaldrÃ¤nder. FrÃ¼chte erst nach dem ersten Frost ernten â€“ dann weniger bitter!',recipes:[{title:'Schlehen-LikÃ¶r',desc:'500g Schlehen (angefroren), 500g Zucker, 1L Korn â€“ 3 Monate stehen lassen, regelmÃ¤ÃŸig schÃ¼tteln.'},{title:'Schlehen-Marmelade',desc:'1 kg Schlehen entkernen, mit Gelierzucker und etwas Wasser kochen, durch Sieb passieren.'}]},
  {name:'Hagebutte',latin:'Rosa canina',emoji:'ğŸ”´',category:'Beeren',stages:['Altpflanze'],monStart:8,monEnd:11,uses:['Tee','Kochen','Medizin'],desc:'Heckenrosen-FrÃ¼chte. Extrem viel Vitamin C. Kerne und HÃ¤rchen entfernen!',recipes:[{title:'Hagebuttentee',desc:'2 EL getrocknete FrÃ¼chte in 400ml Wasser 10 Min. kÃ¶cheln, abseihen. Sehr vitaminreich.'},{title:'Hagebutten-Marmelade',desc:'1 kg FrÃ¼chte, entkernt, kochen bis weich, durch Sieb, mit Gelierzucker einkochen.'}]},
  {name:'Sanddorn',latin:'Hippophae rhamnoides',emoji:'ğŸŸ ',category:'Beeren',stages:['Altpflanze'],monStart:7,monEnd:10,uses:['Kochen','Medizin'],desc:'KÃ¼sten und Flussufer. Oranger Saft extrem vitaminreich.',recipes:[{title:'Sanddorn-Smoothie',desc:'100ml Sanddornsaft, 1 Banane, 200ml Orangensaft, 1 TL Honig â€“ mixen.'},{title:'Sanddorn-Marmelade',desc:'500g Beeren, 250g Gelierzucker 2:1, Orangenschale â€“ einkochen, durch Sieb.'}]},
  {name:'Brombeere',latin:'Rubus fruticosus',emoji:'ğŸ«',category:'Beeren',stages:['Halbwuchs','Altpflanze'],monStart:7,monEnd:9,uses:['Kochen','Tee','Medizin'],desc:'WaldrÃ¤nder, Hecken. Dornen! BlÃ¤tter fÃ¼r Tee verwenden.',recipes:[{title:'Brombeer-Marmelade',desc:'1 kg Brombeeren, 500g Gelierzucker 2:1, Zitronensaft â€“ sprudelnd kochen, heiÃŸ abfÃ¼llen.'},{title:'Brombeer-Blatt-Tee',desc:'Junge Triebe und BlÃ¤tter trocknen. Tee mild adstringierend, gut bei Durchfall.'}]},
  {name:'Himbeere',latin:'Rubus idaeus',emoji:'ğŸ«',category:'Beeren',stages:['Halbwuchs','Altpflanze'],monStart:6,monEnd:9,uses:['Kochen','Tee','Medizin'],desc:'WaldrÃ¤nder, Lichtungen. ZweijÃ¤hrige Triebe tragen FrÃ¼chte.',recipes:[{title:'Himbeer-Sirup',desc:'500g Himbeeren, 300g Zucker, 100ml Wasser â€“ kochen, abseihen, in Flaschen fÃ¼llen.'},{title:'Himbeerblatt-Tee',desc:'Junge BlÃ¤tter trocknen und als Tee â€“ besonders fÃ¼r Frauen (tonisierend auf den Uterus).'}]},
  {name:'Walderdbeere (Monatserdbeere)',latin:'Fragaria Ã— ananassa (wild)',emoji:'ğŸ“',category:'Beeren',stages:['Jungpflanze','Altpflanze'],monStart:5,monEnd:8,uses:['Kochen'],desc:'Sonnige WaldrÃ¤nder. Intensiver Duft und Geschmack.',recipes:[{title:'Erdbeer-Sahne-Torte',desc:'Biskuitboden, frische Walderdbeeren, geschlagene Sahne â€“ einfach und kÃ¶stlich.'}]},
  // OBST / BÃ„UME
  {name:'Holunderbeere',latin:'Sambucus nigra',emoji:'ğŸ«',category:'Beeren',stages:['Altpflanze','Saatgut'],monStart:6,monEnd:9,uses:['Kochen','Tinkturen','Medizin'],desc:'Ãœberall. BlÃ¼ten im Juni, Beeren ab August. Rohe Beeren leicht giftig!',recipes:[{title:'HolunderblÃ¼ten-Sirup',desc:'20 Dolden, 1,5 kg Zucker, 1,5L Wasser, 3 Zitronen â€“ 3 Tage ziehen, abseihen, aufkochen, abfÃ¼llen.'},{title:'Holunder-Saft (Suco)',desc:'Beeren mit wenig Wasser kÃ¶cheln, durch Tuch pressen, mit Zucker und GewÃ¼rzen einkochen.'}]},
  {name:'Apfel (Wildapfel)',latin:'Malus sylvestris',emoji:'ğŸ',category:'Obst',stages:['Altpflanze'],monStart:7,monEnd:10,uses:['Kochen'],desc:'WaldrÃ¤nder. FrÃ¼chte oft sauer aber aromatisch. Gut fÃ¼r Most und Essig.',recipes:[{title:'Apfelmost',desc:'Ã„pfel waschen, reiben/pressen, Saft mit HefenÃ¤hrstoffen vergÃ¤ren lassen (4â€“6 Wochen).'},{title:'Apfelessig',desc:'Apfelmost weiter vergÃ¤ren bis zum Essig â€“ 2â€“3 Monate bei Raumtemperatur.'}]},
  {name:'Birne (Wildbirne)',latin:'Pyrus pyraster',emoji:'ğŸ',category:'Obst',stages:['Altpflanze'],monStart:8,monEnd:10,uses:['Kochen'],desc:'Seltener als Wildapfel. Sehr hartes Holz. FrÃ¼chte erst nach Frost weich.',recipes:[{title:'Birnen-Chutney',desc:'1 kg Birnen, 200g Zwiebeln, 150g Zucker, 100ml Apfelessig, GewÃ¼rze â€“ 30 Min. kochen.'}]},
  {name:'Kornelkirsche',latin:'Cornus mas',emoji:'ğŸ”´',category:'Obst',stages:['Altpflanze'],monStart:8,monEnd:9,uses:['Kochen','Medizin'],desc:'FrÃ¼h blÃ¼hender Strauch. Sehr saure FrÃ¼chte reich an Vitamin C.',recipes:[{title:'Kornelkirsch-Marmelade',desc:'1 kg FrÃ¼chte entkernen, mit 500g Zucker einkochen, abschmecken.'},{title:'Kornelkirsch-LikÃ¶r',desc:'500g FrÃ¼chte, 400g Zucker, 1L Korn, 4 Wochen ziehen lassen.'}]},
  {name:'Speierling',latin:'Sorbus domestica',emoji:'ğŸ',category:'Obst',stages:['Altpflanze'],monStart:9,monEnd:11,uses:['Kochen'],desc:'Seltener Baum. FrÃ¼chte nach Frost genieÃŸbar. FÃ¼r Most sehr geschÃ¤tzt.',recipes:[{title:'Speierling-Most',desc:'FrÃ¼chte nach dem Frost ernten und zu Most verarbeiten. KlÃ¤rt Apfelmost natÃ¼rlich.'}]},
  // PILZE
  {name:'Pfifferling',latin:'Cantharellus cibarius',emoji:'ğŸ„',category:'Pilze',stages:['Altpflanze'],monStart:5,monEnd:9,uses:['Kochen'],desc:'Mischwald unter Fichte und Buche. Unverwechselbar mit falschen Gabeling.',recipes:[{title:'Pfifferling-Rahm-Sauce',desc:'Pfifferlinge putzen, in Butter anbraten, mit Sahne ablÃ¶schen, mit Thymian wÃ¼rzen. Zu Pasta oder KnÃ¶del.'},{title:'Eingelegte Pfifferlinge',desc:'Klein gekochte Pfifferlinge in Essig-Wasser-Sud mit Lorbeer und PfefferkÃ¶rnern einlegen.'}]},
  {name:'Steinpilz',latin:'Boletus edulis',emoji:'ğŸ„',category:'Pilze',stages:['Altpflanze'],monStart:6,monEnd:10,uses:['Kochen'],desc:'KÃ¶nig der Pilze. Unter Fichten, Kiefern, Buchen. Schwamm unter dem Hut prÃ¼fen.',recipes:[{title:'Steinpilz-Risotto',desc:'Arborio-Reis, getrocknete Steinpilze einweichen, mit BrÃ¼he und Parmesan langsam garen.'},{title:'Getrocknete Steinpilze',desc:'In dÃ¼nne Scheiben schneiden und bei 40Â°C im DÃ¶rrgerÃ¤t oder Backofen trocknen.'}]},
  {name:'Schmarotzer-RÃ¶hrling',latin:'Xerocomus parasiticus',emoji:'ğŸ„',category:'Pilze',stages:['Altpflanze'],monStart:7,monEnd:9,uses:['Kochen'],desc:'WÃ¤chst auf dem Kartoffelbovist. Selten aber charakteristisch.',recipes:[{title:'RÃ¶hrlings-Pfanne',desc:'In OlivenÃ¶l anbraten, Knoblauch, Petersilie, Salz, Pfeffer.'}]},
  {name:'BÃ¤rlauch',latin:'Allium ursinum',emoji:'ğŸ§„',category:'Wildpflanzen',stages:['Jungpflanze','Altpflanze'],monStart:2,monEnd:4,uses:['Kochen','Salat'],desc:'BuchenwÃ¤lder, feuchte Standorte. FrÃ¼hjahrsbote! ACHTUNG: Nicht mit MaiglÃ¶ckchen verwechseln â€“ immer Knoblauchgeruch prÃ¼fen!',recipes:[{title:'BÃ¤rlauch-Pesto',desc:'100g BlÃ¤tter, 50g Parmesan, 50g Pinienkerne, 150ml OlivenÃ¶l, Salz, Pfeffer â€“ alles mixen.'},{title:'BÃ¤rlauch-Butter',desc:'100g weiche Butter mit 3 EL fein gehackten BÃ¤rlauch-BlÃ¤ttern vermengen â€“ auf frischem Brot.'}]},
  {name:'Brennnessel',latin:'Urtica dioica',emoji:'ğŸŒ¿',category:'Wildpflanzen',stages:['Jungpflanze','Altpflanze'],monStart:3,monEnd:8,uses:['Tee','Salat','Medizin'],desc:'Stickstoffreiche BÃ¶den, Weg- und WaldrÃ¤nder. Junge Triebe im FrÃ¼hling ernten.',recipes:[{title:'Brennnessel-Tee',desc:'2 EL frische BlÃ¤tter mit 250ml heiÃŸem Wasser Ã¼bergieÃŸen, 10 Min. ziehen lassen.'},{title:'Brennnessel-Suppe',desc:'200g junge Triebe, 1 Zwiebel, 500ml BrÃ¼he â€“ Zwiebel anschwitzen, Brennnesseln zugeben, pÃ¼rieren.'}]},
  {name:'Schafgarbe',latin:'Achillea millefolium',emoji:'ğŸŒ¼',category:'Heilpflanzen',stages:['Halbwuchs','Altpflanze'],monStart:5,monEnd:9,uses:['Tee','Medizin'],desc:'Sonnige Magerwiesen. Blutstillend, krampflÃ¶send.',recipes:[{title:'Schafgarben-Tee',desc:'1 EL BlÃ¼ten und BlÃ¤tter, 250ml heiÃŸes Wasser, 10 Min. ziehen. Bei Menstruationsbeschwerden.'},{title:'Wundtinktur',desc:'50g frische BlÃ¼ten in 250ml Korn, 4 Wochen stehen lassen, abseihen.'}]},
  // BÃ„UME
  {name:'Linde',latin:'Tilia cordata',emoji:'ğŸŒ³',category:'BÃ¤ume',stages:['Altpflanze'],monStart:5,monEnd:7,uses:['Tee','Medizin'],desc:'BlÃ¼ten im Juni/Juli ernten (mit Deckblatt). Beruhigend, schweiÃŸtreibend.',recipes:[{title:'LindenblÃ¼ten-Tee',desc:'2 EL frische oder getrocknete BlÃ¼ten, 250ml heiÃŸes Wasser, 10 Min. ziehen. ErkÃ¤ltungs-Tee.'},{title:'LindenblÃ¼ten-Sirup',desc:'20 Dolden, 1 kg Zucker, 1L Wasser â€“ 2 Tage ziehen, abseihen, aufkochen, in Flaschen.'}]},
  {name:'Birke',latin:'Betula pendula',emoji:'ğŸŒ³',category:'BÃ¤ume',stages:['Jungpflanze','Altpflanze'],monStart:2,monEnd:4,uses:['Tee','Medizin'],desc:'Junge BlÃ¤tter im FrÃ¼hjahr. Birkensaft im MÃ¤rz anzapfen. Harntreibend.',recipes:[{title:'Birkensaft',desc:'Im MÃ¤rz Baum schrÃ¤g anschneiden (nicht zu tief), Schlauch, Flasche. Frisch trinken oder vergÃ¤ren.'},{title:'Birkenblatt-Tee',desc:'Junge BlÃ¤tter, 2 EL auf 250ml Wasser, 10 Min. â€“ entwÃ¤ssernd und entschlackend.'}]},
  {name:'Eiche',latin:'Quercus robur',emoji:'ğŸŒ³',category:'BÃ¤ume',stages:['Altpflanze'],monStart:8,monEnd:10,uses:['Medizin'],desc:'Eichenrinde sehr gerbstoffreich. Adstringierend, entzÃ¼ndungshemmend.',recipes:[{title:'Eichenrinden-Tee',desc:'1 TL Rinde in 250ml Wasser 10 Min. kÃ¶cheln, abseihen. Zum Gurgeln bei Halsschmerzen oder Kompresse.'},{title:'Eichel-Kaffee',desc:'Eicheln schÃ¤len, rÃ¶sten, mahlen â€“ koffeinfreier Kaffeeersatz mit nussigem Aroma.'}]},
  {name:'Walnuss',latin:'Juglans regia',emoji:'ğŸŒ³',category:'BÃ¤ume',stages:['Altpflanze'],monStart:6,monEnd:10,uses:['Kochen','Medizin'],desc:'GrÃ¼ne Schale fÃ¼r Tinkturen (HÃ¤nde verfÃ¤rben!). Reife NÃ¼sse ab September.',recipes:[{title:'GrÃ¼ner Walnuss-LikÃ¶r',desc:'20 grÃ¼ne NÃ¼sse (Juni) halbieren, mit 1L Korn und 500g Zucker 6 Monate ziehen lassen.'},{title:'Walnuss-Pesto',desc:'50g WalnÃ¼sse, 50g Parmesan, Basilikum, OlivenÃ¶l, Knoblauch, Salz.'}]},
  {name:'Fichte',latin:'Picea abies',emoji:'ğŸŒ²',category:'BÃ¤ume',stages:['Jungpflanze','Altpflanze'],monStart:3,monEnd:5,uses:['Kochen','Medizin'],desc:'Junge hellgrÃ¼ne Triebspitzen im FrÃ¼hling ernten. Sehr vitaminreich.',recipes:[{title:'Fichten-Sirup',desc:'200g junge Triebe, 500ml Wasser, 500g Zucker â€“ 24h ziehen, aufkochen, abseihen, abfÃ¼llen.'},{title:'Fichtennadel-Tee',desc:'2 EL frische Nadeln, 250ml heiÃŸes Wasser, 10 Min. Ziehen. Reich an Vitamin C.'}]},
];

function openDBModal(){
  renderDB();
  document.getElementById('dbOverlay').classList.add('open');
}

function renderDB(){
  const q=(document.getElementById('dbSearch')?.value||'').toLowerCase();
  const cat=(document.getElementById('dbCatFilter')?.value||'');
  let list=PLANT_DB.filter(p=>{
    const mq=!q||p.name.toLowerCase().includes(q)||(p.latin||'').toLowerCase().includes(q);
    const mc=!cat||p.category===cat;
    return mq&&mc;
  });
  // Remove already added plants
  const added=new Set(plants.map(p=>p.name.toLowerCase()));
  const grid=document.getElementById('dbGrid');
  if(!list.length){grid.innerHTML='<p style="color:var(--text-muted);padding:20px;font-size:.9rem;">Keine Pflanzen gefunden</p>';return;}
  grid.innerHTML=list.map(p=>{
    const cc=catColor(p.category||'');
    const isAdded=added.has(p.name.toLowerCase());
    return `<div class="db-card ${isAdded?'':''}${isAdded?'" style="opacity:.5;cursor:default;"':'"'} 
      onclick="${isAdded?'':'addFromDB(\''+p.name.replace(/'/g,"\\'")+'\')'}" title="${isAdded?'Bereits eingetragen':'HinzufÃ¼gen'}">
      <div class="db-emoji">${p.emoji||'ğŸŒ¿'}</div>
      <div class="db-name">${p.name}${isAdded?' âœ“':''}</div>
      <div class="db-latin">${p.latin||''}</div>
      <span class="db-cat" style="background:${cc}">${p.category||''}</span>
    </div>`;
  }).join('');
}

function addFromDB(name){
  const template=PLANT_DB.find(p=>p.name===name); if(!template)return;
  // Check not duplicate
  if(plants.find(p=>p.name.toLowerCase()===name.toLowerCase())){
    notify('âš ï¸ Diese Pflanze ist bereits eingetragen');return;
  }
  const newPlant={
    ...template,
    id:Date.now(),
    locations:[],
    photo:null,
  };
  plants.push(newPlant);
  save();
  renderDB(); // refresh to mark as added
  renderPlants();
  notify(`âœ… ${name} aus Datenbank hinzugefÃ¼gt!`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
load();
updateCatSelects();
renderPlants();

// â”€â”€ SERVICE WORKER REGISTRIERUNG â”€â”€
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('[PWA] Service Worker registriert:', reg.scope))
      .catch(err => console.log('[PWA] SW Fehler:', err));
  });
}

// â”€â”€ PWA INSTALL BANNER â”€â”€
let deferredPrompt = null;
const installBanner = document.getElementById('installBanner');
const installBtn = document.getElementById('installBtn');
const installDismiss = document.getElementById('installDismiss');

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  if(installBanner) installBanner.style.display = 'flex';
});

if(installBtn) {
  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') notify('ğŸ‰ App wurde installiert!');
    deferredPrompt = null;
    installBanner.style.display = 'none';
  });
}
if(installDismiss) {
  installDismiss.addEventListener('click', () => {
    installBanner.style.display = 'none';
  });
}

window.addEventListener('appinstalled', () => {
  if(installBanner) installBanner.style.display = 'none';
  notify('âœ… Pflanzenfinder wurde als App installiert!');
});
</script>
</body>
</html>
